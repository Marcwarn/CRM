<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doings Sales Intelligence</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            color: #6b7280;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .tabs {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 30px;
        }

        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1.1em;
            color: #6b7280;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 600;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            background: #f9fafb;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #e5e7eb;
        }

        .section h2 {
            color: #1f2937;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .section h3 {
            color: #374151;
            margin-bottom: 15px;
            margin-top: 20px;
            font-size: 1.2em;
        }

        input[type="text"], input[type="number"], input[type="date"], select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            margin-bottom: 15px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        button {
            padding: 12px 25px;
            font-size: 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .primary-btn {
            background: #667eea;
            color: white;
        }

        .primary-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.4);
        }

        .secondary-btn {
            background: #e0e0e0;
            color: #333;
            margin-left: 10px;
        }

        .success-btn {
            background: #22c55e;
            color: white;
        }

        .danger-btn {
            background: #ef4444;
            color: white;
        }

        .deal-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .deal-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .deal-card.hot {
            border-left-color: #ef4444;
            background: #fef2f2;
        }

        .deal-card.stale {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }

        .deal-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .deal-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #1f2937;
        }

        .deal-value {
            font-size: 1.2em;
            font-weight: 700;
            color: #667eea;
        }

        .deal-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #6b7280;
            font-size: 0.95em;
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge.stage-tut {
            background: #dcfce7;
            color: #166534;
        }

        .badge.stage-sharp {
            background: #fef3c7;
            color: #92400e;
        }

        .badge.stage-talk {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge.stage-offer {
            background: #e0e7ff;
            color: #3730a3;
        }

        .badge.stage-lost {
            background: #fee2e2;
            color: #991b1b;
        }

        .insight-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .insight-box.warning {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }

        .insight-box.success {
            border-left-color: #22c55e;
            background: #f0fdf4;
        }

        .insight-box h4 {
            color: #1f2937;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.95em;
        }

        .action-list {
            list-style: none;
            padding: 0;
        }

        .action-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 2px solid #e5e7eb;
        }

        .action-icon {
            font-size: 1.5em;
        }

        .action-content {
            flex: 1;
        }

        .action-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .action-desc {
            color: #6b7280;
            font-size: 0.9em;
        }

        .hidden {
            display: none;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .chart-placeholder {
            background: #f3f4f6;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            color: #6b7280;
            font-style: italic;
        }

        .network-match {
            background: #eff6ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            border: 2px solid #3b82f6;
        }

        .ai-suggestion {
            background: linear-gradient(135deg, #667eea22 0%, #764ba222 100%);
            padding: 20px;
            border-radius: 12px;
            margin-top: 15px;
            border: 2px solid #667eea;
        }

        .ai-suggestion h4 {
            color: #667eea;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .deal-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .empty-state h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .retro-section {
            margin-bottom: 30px;
        }

        .learning-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #22c55e;
        }

        .stage-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9fafb;
            border-radius: 12px;
            border: 2px solid #e5e7eb;
        }

        .stage-section h3 {
            margin-bottom: 15px;
            color: #1f2937;
            font-size: 1.2em;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }

        .stage-empty {
            padding: 20px;
            text-align: center;
            color: #9ca3af;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Doings Sales Intelligence</h1>
        <p class="subtitle">Sales Intelligence Platform</p>

        <div class="tabs">
            <button class="tab active" onclick="showTab('pipeline')">Pipeline</button>
            <button class="tab" onclick="showTab('team')">Team</button>
            <button class="tab" onclick="showTab('konsult')">Konsult</button>
            <button class="tab" onclick="showTab('ledning')">Analys</button>
            <button class="tab" onclick="showTab('input')">L√§gg till</button>
        </div>

        <!-- PIPELINE VY (HUVUDVY) -->
        <div id="pipeline-view" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="pipeline-total-value">0 kr</div>
                    <div class="stat-label">Total Pipeline</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="pipeline-deal-count">0</div>
                    <div class="stat-label">Antal Deals</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="pipeline-avg-value">0 kr</div>
                    <div class="stat-label">Genomsnitt per Deal</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="pipeline-expected">0 kr</div>
                    <div class="stat-label">F√∂rv√§ntat att St√§nga</div>
                </div>
            </div>

            <!-- PIPELINE PER STAGE -->
            <div class="section">
                <h2>Pipeline per Stage</h2>
                
                <div class="stage-section">
                    <h3>Tut! (N√§stan klart)</h3>
                    <div id="stage-tut" class="deal-list"></div>
                </div>

                <div class="stage-section">
                    <h3>Skarpt l√§ge</h3>
                    <div id="stage-sharp" class="deal-list"></div>
                </div>

                <div class="stage-section">
                    <h3>Skriver/skickat offert</h3>
                    <div id="stage-offer" class="deal-list"></div>
                </div>

                <div class="stage-section">
                    <h3>Kundsnack</h3>
                    <div id="stage-talk" class="deal-list"></div>
                </div>

                <div class="stage-section">
                    <h3>Tappat uppdrag</h3>
                    <div id="stage-lost" class="deal-list"></div>
                </div>
            </div>
        </div>

        <!-- TEAM VY -->
        <div id="team-view" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="team-total-value">0 kr</div>
                    <div class="stat-label">Total Pipeline</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="team-deal-count">0</div>
                    <div class="stat-label">Aktiva Deals</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="team-hot-count">0</div>
                    <div class="stat-label">Heta Deals</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="team-stale-count">0</div>
                    <div class="stat-label">Risk Deals</div>
                </div>
            </div>

            <div class="section">
                <h2>üî• Heta Deals (Beh√∂ver Attention)</h2>
                <div id="hot-deals" class="deal-list"></div>
            </div>

            <div class="section">
                <h2>‚ö†Ô∏è Risk Deals (Inget h√§nder)</h2>
                <div id="stale-deals" class="deal-list"></div>
            </div>

            <div class="section">
                <h2>üíº Network Opportunities</h2>
                <div id="network-opportunities"></div>
            </div>

            <div class="section">
                <h2>üìã Alla Deals</h2>
                <div id="all-deals" class="deal-list"></div>
            </div>
        </div>

        <!-- KONSULT VY -->
        <div id="konsult-view" class="tab-content">
            <div class="section">
                <h2>V√§lj Konsult</h2>
                <select id="konsult-selector" onchange="updateKonsultView()">
                    <option value="">V√§lj konsult...</option>
                </select>
            </div>

            <div id="konsult-content" class="hidden">
                <div class="section">
                    <h2>üëã Hej <span id="konsult-name"></span>!</h2>
                    
                    <h3>üéØ Idag</h3>
                    <ul class="action-list" id="konsult-today"></ul>

                    <h3>üíº Dina Deals</h3>
                    <div id="konsult-deals"></div>

                    <h3>üåê Ditt N√§tverk Kan Hj√§lpa</h3>
                    <div id="konsult-network"></div>
                </div>
            </div>
        </div>

        <!-- LEDNING VY -->
        <div id="ledning-view" class="tab-content">
            <div class="section">
                <h2>üìà Strategisk Intelligence</h2>
                
                <h3>Pipeline F√∂rdelning</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="ledning-avg-deal">0 kr</div>
                        <div class="stat-label">Genomsnittligt Deal-v√§rde</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="ledning-cycle-time">0</div>
                        <div class="stat-label">Genomsnittlig Cycle (dagar)</div>
                    </div>
                </div>

                <h3>üéØ Vart G√•r Pengarna?</h3>
                <div id="service-breakdown"></div>

                <h3>üë• Konsult-f√∂rdelning</h3>
                <div id="consultant-breakdown"></div>

                <h3>‚ö†Ô∏è Var L√§cker Det?</h3>
                <div id="leakage-analysis"></div>

                <h3>üí° AI Rekommendationer</h3>
                <div id="strategic-recommendations"></div>
            </div>
        </div>

        <!-- RETRO VY -->
        <div id="retro-view" class="tab-content">
            <div class="section">
                <h2>üìö Collective Learning</h2>
                
                <div class="retro-section">
                    <h3>üéâ Vunna Deals</h3>
                    <div id="retro-wins"></div>
                </div>

                <div class="retro-section">
                    <h3>üòû F√∂rlorade Deals</h3>
                    <div id="retro-losses"></div>
                </div>

                <div class="retro-section">
                    <h3>üìñ L√§rdomar</h3>
                    <div id="retro-learnings"></div>
                </div>

                <div class="retro-section">
                    <h3>üéØ N√§sta M√•nad - Fokus P√•</h3>
                    <div id="retro-focus"></div>
                </div>
            </div>
        </div>

        <!-- INPUT VY -->
        <div id="input-view" class="tab-content">
            <div class="section">
                <h2>L√§gg till Deal</h2>
                
                <!-- AI INPUT SEKTION -->
                <div style="background: #f0f9ff; padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 2px solid #3b82f6;">
                    <h3 style="margin-bottom: 15px; color: #1e40af;">Snabbt l√§gg till med AI</h3>
                    <p style="color: #1e40af; margin-bottom: 15px; font-size: 0.95em;">
                        Ber√§tta vad som h√§nde - AI:n fyller i f√§lten nedan automatiskt
                    </p>
                    
                    <textarea 
                        id="ai-input" 
                        placeholder="Exempel: 'Tr√§ffade Anna p√• Volvo idag. De beh√∂ver hj√§lp med ledarutveckling f√∂r sina tech-teams. Cirka 400k. Vi √§r i tidigt snack-l√§ge.'"
                        style="min-height: 100px; font-size: 15px; width: 100%; margin-bottom: 15px;"
                    ></textarea>

                    <div style="display: flex; gap: 10px;">
                        <button class="primary-btn" onclick="fillFormWithAI()" id="ai-fill-btn">
                            <span id="ai-fill-text">Fyll i f√§lt med AI</span>
                        </button>
                        <button class="secondary-btn" onclick="startVoiceInput()" id="voice-btn">
                            <span id="voice-btn-text">üé§ Tala in</span>
                        </button>
                        <button class="secondary-btn" onclick="clearAIInput()">
                            Rensa
                        </button>
                    </div>
                </div>

                <!-- FORMUL√ÑR (ALLTID SYNLIGT) -->
                <form id="deal-form" onsubmit="saveDeal(event)">
                    <div class="form-row">
                        <div>
                            <label>F√∂retag *</label>
                            <input type="text" id="company" required placeholder="t.ex. Mojang AB">
                        </div>
                        <div>
                            <label>Deal-v√§rde (kr)</label>
                            <input type="number" id="value" placeholder="t.ex. 250000">
                        </div>
                    </div>

                    <div class="form-row">
                        <div>
                            <label>Stage *</label>
                            <select id="stage" required>
                                <option value="">V√§lj stage...</option>
                                <option value="Tut!">Tut!</option>
                                <option value="Skarpt l√§ge">Skarpt l√§ge</option>
                                <option value="Skriver/skickat offert">Skriver/skickat offert</option>
                                <option value="Kundsnack">Kundsnack</option>
                                <option value="Tappat uppdrag">Tappat uppdrag</option>
                            </select>
                        </div>
                        <div>
                            <label>Deal Owner *</label>
                            <input type="text" id="owner" required placeholder="t.ex. Emma">
                        </div>
                    </div>

                    <label>Typ av Uppdrag</label>
                    <input type="text" id="service" placeholder="t.ex. Ledarutveckling, OneBrand, Coaching">

                    <label>Kontaktperson</label>
                    <input type="text" id="contact" placeholder="Namn och titel">

                    <label>Senaste Aktivitet</label>
                    <input type="date" id="last-activity">

                    <label>N√§sta Steg</label>
                    <input type="text" id="next-step" placeholder="t.ex. Uppf√∂ljningsm√∂te 24 jan">

                    <label>Kommentar/Status</label>
                    <textarea id="comment" placeholder="Vad √§r l√§get? Vad h√§nde senast?"></textarea>

                    <label>Problem/Behov (fr√•n kund)</label>
                    <textarea id="problem" placeholder="Vad √§r kundens utmaning? Vad vill de √•stadkomma?"></textarea>

                    <label>√ñvrigt</label>
                    <textarea id="other" placeholder="Annan information som inte passar i √∂vriga f√§lt"></textarea>

                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="submit" class="primary-btn">L√§gg till Deal</button>
                        <button type="button" class="secondary-btn" onclick="clearForm()">Rensa formul√§r</button>
                    </div>
                </form>
            </div>

            <div class="section">
                <h2>Import/Export</h2>
                
                <h3 style="margin-bottom: 15px;">Importera fr√•n CSV (Slack s√§ljpipe)</h3>
                <p style="color: #6b7280; margin-bottom: 15px; font-size: 0.95em;">
                    Ladda upp er s√§ljpipe CSV-fil fr√•n Slack. Systemet mappar automatiskt kolumnerna.
                </p>
                <button class="primary-btn" onclick="document.getElementById('csv-file').click()">
                    Importera CSV
                </button>
                <input type="file" id="csv-file" class="hidden" accept=".csv" onchange="importCSV(event)">
                
                <div id="csv-preview" class="hidden" style="margin-top: 20px; padding: 20px; background: #f9fafb; border-radius: 8px;">
                    <h4 style="margin-bottom: 10px;">F√∂rhandsgranskning:</h4>
                    <div id="csv-preview-content" style="margin-bottom: 15px; max-height: 300px; overflow-y: auto;"></div>
                    <div style="display: flex; gap: 10px;">
                        <button class="success-btn" onclick="confirmCSVImport()">Importera dessa deals</button>
                        <button class="secondary-btn" onclick="cancelCSVImport()">Avbryt</button>
                    </div>
                </div>

                <h3 style="margin-top: 30px; margin-bottom: 15px;">Exportera/Backup</h3>
                <button class="secondary-btn" onclick="exportData()">Exportera Data (JSON)</button>
                <button class="secondary-btn" onclick="exportCSV()">Exportera som CSV</button>
                
                <h3 style="margin-top: 30px; margin-bottom: 15px;">Testdata</h3>
                <button class="secondary-btn" onclick="document.getElementById('import-file').click()">Importera JSON</button>
                <button class="secondary-btn" onclick="loadSampleData()">Ladda Exempeldata</button>
                <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(event)">
            </div>
        </div>
    </div>

    <script>
        // Data storage
        let deals = [];
        let networks = []; // LinkedIn kontakter (placeholder f√∂r framtiden)

        // Load data fr√•n localStorage
        function loadData() {
            const saved = localStorage.getItem('doings-deals');
            if (saved) {
                deals = JSON.parse(saved);
            }
        }

        // Save data till localStorage
        function saveData() {
            localStorage.setItem('doings-deals', JSON.stringify(deals));
        }

        // AI Deal Processing
        let recognition = null;

        // Initialize speech recognition
        function initVoiceRecognition() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'sv-SE';
                
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('ai-input').value += (document.getElementById('ai-input').value ? ' ' : '') + transcript;
                    document.getElementById('voice-btn-text').textContent = 'üé§ Tala in';
                };
                
                recognition.onerror = function(event) {
                    alert('R√∂stinspelning misslyckades: ' + event.error);
                    document.getElementById('voice-btn-text').textContent = 'üé§ Tala in';
                };
                
                recognition.onend = function() {
                    document.getElementById('voice-btn-text').textContent = 'üé§ Tala in';
                };
            }
        }

        initVoiceRecognition();

        // Start voice input
        function startVoiceInput() {
            if (!recognition) {
                alert('R√∂stinspelning st√∂ds inte i denna webbl√§sare. Prova Chrome.');
                return;
            }
            
            document.getElementById('voice-btn-text').textContent = 'üî¥ Lyssnar...';
            recognition.start();
        }

        // Clear AI input
        function clearAIInput() {
            document.getElementById('ai-input').value = '';
        }

        // Fill form with AI
        async function fillFormWithAI() {
            const input = document.getElementById('ai-input').value.trim();
            
            if (!input) {
                alert('Skriv eller tala in information om dealen f√∂rst');
                return;
            }
            
            const btn = document.getElementById('ai-fill-btn');
            btn.disabled = true;
            document.getElementById('ai-fill-text').textContent = 'AI analyserar...';
            
            try {
                const extracted = await extractDealInfo(input);
                
                // Fyll i formul√§rf√§lt
                if (extracted.company) document.getElementById('company').value = extracted.company;
                if (extracted.value) document.getElementById('value').value = extracted.value;
                if (extracted.stage) document.getElementById('stage').value = extracted.stage;
                if (extracted.owner) document.getElementById('owner').value = extracted.owner;
                if (extracted.service) document.getElementById('service').value = extracted.service;
                if (extracted.contact) document.getElementById('contact').value = extracted.contact;
                if (extracted.nextStep) document.getElementById('next-step').value = extracted.nextStep;
                if (extracted.problem) document.getElementById('problem').value = extracted.problem;
                if (extracted.comment) document.getElementById('comment').value = extracted.comment;
                
                // Allt som inte passade i f√§lt ‚Üí √ñvrigt
                if (extracted.other) {
                    document.getElementById('other').value = extracted.other;
                }
                
                // Clear AI input efter framg√•ngsrik extraktion
                document.getElementById('ai-input').value = '';
                
                // Scroll till formul√§ret
                document.getElementById('deal-form').scrollIntoView({ behavior: 'smooth', block: 'start' });
                
            } catch (error) {
                alert('Fel vid AI-analys: ' + error.message);
            } finally {
                btn.disabled = false;
                document.getElementById('ai-fill-text').textContent = 'Fyll i f√§lt med AI';
            }
        }

        // Extract deal info using AI (simulated - replace with real Claude API call)
        async function extractDealInfo(text) {
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 800));
            
            const originalText = text;
            let remainingText = text;
            
            const deal = {
                company: null,
                value: 0,
                stage: 'Kundsnack',
                owner: 'Marcus', // Default
                service: null,
                contact: null,
                problem: null,
                nextStep: null,
                comment: null,
                other: null,
                lastActivity: new Date().toISOString().split('T')[0],
                created: new Date().toISOString()
            };
            
            // Extract company
            const companyPatterns = [
                /(?:tr√§ffade|m√∂te med|pitch|hos|fr√•n)\s+([A-Z√Ö√Ñ√ñ][a-z√•√§√∂]+(?:\s+[A-Z√Ö√Ñ√ñ][A-Z]+)?)/i,
                /([A-Z√Ö√Ñ√ñ][a-z√•√§√∂]+(?:\s+[A-Z√Ö√Ñ√ñ][A-Z]+)?)/
            ];
            
            for (const pattern of companyPatterns) {
                const match = remainingText.match(pattern);
                if (match) {
                    deal.company = match[1];
                    remainingText = remainingText.replace(match[1], '');
                    break;
                }
            }
            
            // Extract value
            const valuePatterns = [
                /(\d+(?:[,\s]\d+)?)\s*(?:miljoner?|mkr)/i,
                /(\d+)\s*(?:tusen|k)\b/i,
                /(\d[\d\s]+)\s*kr/i
            ];
            
            for (const pattern of valuePatterns) {
                const match = remainingText.match(pattern);
                if (match) {
                    let value = match[1].replace(/[\s,]/g, '');
                    if (remainingText.toLowerCase().includes('miljon') || remainingText.toLowerCase().includes('mkr')) {
                        deal.value = parseInt(value) * 1000000;
                    } else if (remainingText.toLowerCase().includes('tusen') || remainingText.toLowerCase().includes('k')) {
                        deal.value = parseInt(value) * 1000;
                    } else {
                        deal.value = parseInt(value);
                    }
                    remainingText = remainingText.replace(match[0], '');
                    break;
                }
            }
            
            // Extract stage
            if (remainingText.match(/pitch|pitcha/i)) {
                deal.stage = 'Skarpt l√§ge';
            } else if (remainingText.match(/offert|offererat/i)) {
                deal.stage = 'Skriver/skickat offert';
            } else if (remainingText.match(/n√§stan klar|vinn|beslutar snart|tut/i)) {
                deal.stage = 'Tut!';
            } else if (remainingText.match(/tappat|f√∂rlorat|valde annan/i)) {
                deal.stage = 'Tappat uppdrag';
            }
            
            // Extract service
            const services = {
                'ledarutveckling': 'Ledarutveckling',
                'onebrand': 'OneBrand',
                'coaching': 'Coaching',
                'kultur': 'Kultur',
                'workshop': 'Workshop'
            };
            
            for (const [key, value] of Object.entries(services)) {
                if (remainingText.toLowerCase().includes(key)) {
                    deal.service = value;
                    remainingText = remainingText.replace(new RegExp(key, 'gi'), '');
                    break;
                }
            }
            
            // Extract contact person
            const contactMatch = remainingText.match(/(?:tr√§ffade|med|kontakt)\s+([A-Z√Ö√Ñ√ñ][a-z√•√§√∂]+(?:\s+[A-Z√Ö√Ñ√ñ][a-z√•√§√∂]+)?)/);
            if (contactMatch) {
                deal.contact = contactMatch[1];
                remainingText = remainingText.replace(contactMatch[0], '');
            }
            
            // Extract problem/need
            const problemPatterns = [
                /beh√∂ver?\s+(.*?)(?:\.|,|$)/i,
                /vill\s+(.*?)(?:\.|,|$)/i,
                /problem.*?:\s*(.*?)(?:\.|,|$)/i
            ];
            
            for (const pattern of problemPatterns) {
                const match = remainingText.match(pattern);
                if (match) {
                    deal.problem = match[1].trim();
                    remainingText = remainingText.replace(match[0], '');
                    break;
                }
            }
            
            // Extract next step
            const nextStepPatterns = [
                /n√§sta\s+vecka/i,
                /√•terkomma/i,
                /bokat\s+m√∂te/i,
                /beslutar/i,
                /uppf√∂ljning/i
            ];
            
            for (const pattern of nextStepPatterns) {
                const match = remainingText.match(pattern);
                if (match) {
                    const context = remainingText.substring(Math.max(0, match.index - 50), Math.min(remainingText.length, match.index + 100));
                    deal.nextStep = context.trim();
                    remainingText = remainingText.replace(context, '');
                    break;
                }
            }
            
            // What's left that's meaningful goes to "other"
            const cleaned = remainingText.replace(/\s+/g, ' ').trim();
            if (cleaned.length > 20) { // Only if there's substantial content left
                deal.other = cleaned;
            }
            
            // Original text as comment if we want to keep full context
            deal.comment = originalText;
            
            return deal;
        }

        // Save deal from form
        function saveDeal(event) {
            event.preventDefault();
            
            const deal = {
                id: Date.now(),
                company: document.getElementById('company').value,
                value: parseInt(document.getElementById('value').value) || 0,
                stage: document.getElementById('stage').value,
                owner: document.getElementById('owner').value,
                service: document.getElementById('service').value,
                contact: document.getElementById('contact').value,
                lastActivity: document.getElementById('last-activity').value || new Date().toISOString().split('T')[0],
                nextStep: document.getElementById('next-step').value,
                comment: document.getElementById('comment').value,
                problem: document.getElementById('problem').value,
                other: document.getElementById('other').value,
                created: new Date().toISOString()
            };
            
            deals.push(deal);
            saveData();
            
            clearForm();
            alert('Deal sparad!');
            
            updateAllViews();
            
            // Switch to pipeline view
            document.querySelector('.tab').click();
        }

        // Clear form
        function clearForm() {
            document.getElementById('deal-form').reset();
            document.getElementById('ai-input').value = '';
        }

        // Initialize
        loadData();
        updateAllViews();

        // Tab switching
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-view').classList.add('active');
            
            updateAllViews();
        }

        // Add deal
        function addDeal(event) {
            event.preventDefault();
            
            const deal = {
                id: Date.now(),
                company: document.getElementById('company').value,
                value: parseInt(document.getElementById('value').value) || 0,
                stage: document.getElementById('stage').value,
                owner: document.getElementById('owner').value,
                service: document.getElementById('service').value,
                contact: document.getElementById('contact').value,
                lastActivity: document.getElementById('last-activity').value || new Date().toISOString().split('T')[0],
                nextStep: document.getElementById('next-step').value,
                comment: document.getElementById('comment').value,
                problem: document.getElementById('problem').value,
                created: new Date().toISOString()
            };
            
            deals.push(deal);
            saveData();
            
            document.getElementById('deal-form').reset();
            alert('Deal tillagd!');
            
            updateAllViews();
        }

        // Calculate days since last activity
        function daysSince(dateStr) {
            const lastDate = new Date(dateStr);
            const today = new Date();
            const diff = today - lastDate;
            return Math.floor(diff / (1000 * 60 * 60 * 24));
        }

        // Format currency
        function formatCurrency(value) {
            if (!value) return '‚Äî';
            return new Intl.NumberFormat('sv-SE', { 
                style: 'decimal',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value) + ' kr';
        }

        // Get stage badge class
        function getStageBadgeClass(stage) {
            const map = {
                'Tut!': 'stage-tut',
                'Skarpt l√§ge': 'stage-sharp',
                'Kundsnack': 'stage-talk',
                'Skriver/skickat offert': 'stage-offer',
                'Tappat uppdrag': 'stage-lost'
            };
            return map[stage] || 'stage-talk';
        }

        // Render deal card
        function renderDealCard(deal) {
            const days = daysSince(deal.lastActivity);
            const isStale = days > 30;
            const isHot = deal.stage === 'Tut!' || deal.stage === 'Skarpt l√§ge';
            
            let cardClass = 'deal-card';
            if (isHot) cardClass += ' hot';
            else if (isStale) cardClass += ' stale';
            
            const aiInsights = generateAIInsights(deal);
            
            return `
                <div class="${cardClass}">
                    <div class="deal-header">
                        <div>
                            <div class="deal-title">${deal.company}</div>
                            <span class="badge ${getStageBadgeClass(deal.stage)}">${deal.stage}</span>
                        </div>
                        <div class="deal-value">${formatCurrency(deal.value)}</div>
                    </div>
                    <div class="deal-meta">
                        <div class="meta-item">Owner: ${deal.owner}</div>
                        <div class="meta-item">Service: ${deal.service || '‚Äî'}</div>
                        <div class="meta-item">Senaste: ${days} dagar sedan</div>
                        ${deal.contact ? `<div class="meta-item">Kontakt: ${deal.contact}</div>` : ''}
                    </div>
                    ${deal.problem ? `<div style="margin-top: 10px;"><strong>Problem:</strong> ${deal.problem}</div>` : ''}
                    ${deal.nextStep ? `<div style="margin-top: 5px;"><strong>N√§sta steg:</strong> ${deal.nextStep}</div>` : ''}
                    ${deal.comment ? `<div style="margin-top: 5px; color: #6b7280;"><strong>Kommentar:</strong> ${deal.comment}</div>` : ''}
                    ${deal.other ? `<div style="margin-top: 5px; color: #6b7280;"><strong>√ñvrigt:</strong> ${deal.other}</div>` : ''}
                    ${aiInsights ? `<div class="ai-suggestion">${aiInsights}</div>` : ''}
                    <div style="margin-top: 15px;">
                        <button class="secondary-btn" onclick="editDeal(${deal.id})">Redigera</button>
                        <button class="danger-btn" onclick="deleteDeal(${deal.id})">Radera</button>
                    </div>
                </div>
            `;
        }

        // Generate AI insights for a deal
        function generateAIInsights(deal) {
            const days = daysSince(deal.lastActivity);
            const insights = [];
            
            // Stale deal warning
            if (days > 60 && deal.stage !== 'Tappat uppdrag') {
                insights.push(`
                    <h4>VARNING: Ingen aktivitet</h4>
                    <p>Ingen aktivitet p√• ${days} dagar. Deals i ${deal.stage} med >60 dagars inaktivitet har historiskt 80% risk att d√∂.</p>
                    <p><strong>F√∂rslag:</strong> Boka uppf√∂ljningsm√∂te NU. Anledning att h√∂ra av dig: "Q1 planning" eller "Vill st√§mma av timeline"</p>
                `);
            }
            
            // Next step missing
            if (!deal.nextStep && deal.stage !== 'Tappat uppdrag') {
                insights.push(`
                    <h4>AI F√∂rslag</h4>
                    <p>Ingen n√§sta steg planerat. Deals utan tydlig next action stannar ofta av.</p>
                    <p><strong>Rekommendation:</strong> Boka konkret n√§sta m√∂te eller aktivitet.</p>
                `);
            }
            
            // Hot deal suggestions
            if (deal.stage === 'Tut!' || deal.stage === 'Skarpt l√§ge') {
                insights.push(`
                    <h4>Hot Deal - Success Tips</h4>
                    <p>Baserat p√• liknande deals:</p>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>Visa relevanta case fr√•n liknande kunder</li>
                        <li>F√∂resl√• pilot-approach om de tveker</li>
                        <li>Boka uppf√∂ljning inom 5 dagar efter pitch</li>
                    </ul>
                `);
            }
            
            return insights.length > 0 ? insights.join('') : null;
        }

        // Update Pipeline View (HUVUDVY)
        function updatePipelineView() {
            const activeDeals = deals.filter(d => d.stage !== 'Tappat uppdrag');
            const allDeals = deals;
            
            // Stats
            const totalValue = activeDeals.reduce((sum, d) => sum + d.value, 0);
            const avgValue = activeDeals.length > 0 ? totalValue / activeDeals.length : 0;
            
            // Expected to close (Tut! + Skarpt l√§ge med 60% probability)
            const hotDeals = activeDeals.filter(d => d.stage === 'Tut!' || d.stage === 'Skarpt l√§ge');
            const expected = hotDeals.reduce((sum, d) => sum + d.value, 0) * 0.6;
            
            document.getElementById('pipeline-total-value').textContent = formatCurrency(totalValue);
            document.getElementById('pipeline-deal-count').textContent = activeDeals.length;
            document.getElementById('pipeline-avg-value').textContent = formatCurrency(avgValue);
            document.getElementById('pipeline-expected').textContent = formatCurrency(expected);
            
            // Group by stage
            const stages = {
                'Tut!': allDeals.filter(d => d.stage === 'Tut!'),
                'Skarpt l√§ge': allDeals.filter(d => d.stage === 'Skarpt l√§ge'),
                'Skriver/skickat offert': allDeals.filter(d => d.stage === 'Skriver/skickat offert'),
                'Kundsnack': allDeals.filter(d => d.stage === 'Kundsnack'),
                'Tappat uppdrag': allDeals.filter(d => d.stage === 'Tappat uppdrag')
            };
            
            // Render each stage
            const stageIds = ['tut', 'sharp', 'offer', 'talk', 'lost'];
            const stageKeys = ['Tut!', 'Skarpt l√§ge', 'Skriver/skickat offert', 'Kundsnack', 'Tappat uppdrag'];
            
            stageIds.forEach((id, index) => {
                const stageDeals = stages[stageKeys[index]];
                const container = document.getElementById('stage-' + id);
                
                if (stageDeals.length === 0) {
                    container.innerHTML = '<div class="stage-empty">Inga deals i detta stage</div>';
                } else {
                    const totalStageValue = stageDeals.reduce((sum, d) => sum + d.value, 0);
                    const header = `<div style="margin-bottom: 15px; color: #6b7280;">
                        ${stageDeals.length} deals ¬∑ ${formatCurrency(totalStageValue)}
                    </div>`;
                    container.innerHTML = header + stageDeals.map(renderDealCard).join('');
                }
            });
        }

        // Update Team View
        function updateTeamView() {
            const activeDeals = deals.filter(d => d.stage !== 'Tappat uppdrag');
            const hotDeals = activeDeals.filter(d => d.stage === 'Tut!' || d.stage === 'Skarpt l√§ge');
            const staleDeals = activeDeals.filter(d => daysSince(d.lastActivity) > 30);
            
            const totalValue = activeDeals.reduce((sum, d) => sum + d.value, 0);
            
            document.getElementById('team-total-value').textContent = formatCurrency(totalValue);
            document.getElementById('team-deal-count').textContent = activeDeals.length;
            document.getElementById('team-hot-count').textContent = hotDeals.length;
            document.getElementById('team-stale-count').textContent = staleDeals.length;
            
            // Hot deals
            const hotDealsHtml = hotDeals.length > 0 
                ? hotDeals.map(renderDealCard).join('')
                : '<div class="empty-state"><h3>Inga heta deals just nu</h3></div>';
            document.getElementById('hot-deals').innerHTML = hotDealsHtml;
            
            // Stale deals
            const staleDealsHtml = staleDeals.length > 0
                ? staleDeals.map(renderDealCard).join('')
                : '<div class="empty-state"><h3>Inga risk deals! üéâ</h3></div>';
            document.getElementById('stale-deals').innerHTML = staleDealsHtml;
            
            // All deals
            const allDealsHtml = activeDeals.length > 0
                ? activeDeals.map(renderDealCard).join('')
                : '<div class="empty-state"><h3>Inga deals √§n</h3><p>L√§gg till din f√∂rsta deal!</p></div>';
            document.getElementById('all-deals').innerHTML = allDealsHtml;
            
            // Network opportunities (placeholder)
            document.getElementById('network-opportunities').innerHTML = `
                <div class="insight-box">
                    <h4>üíº Network Intelligence</h4>
                    <p><em>Ladda upp LinkedIn-kontakter f√∂r att se network opportunities</em></p>
                    <p style="margin-top: 10px;">N√§r du laddar upp konsulters LinkedIn CSV kommer systemet automatiskt matcha mot aktiva deals och visa:</p>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>Vilka konsulter som har kontakter p√• prospektkunder</li>
                        <li>Warm intro-m√∂jligheter</li>
                        <li>B√§sta timing f√∂r introduktioner</li>
                    </ul>
                </div>
            `;
        }

        // Update Konsult View
        function updateKonsultView() {
            const selector = document.getElementById('konsult-selector');
            const content = document.getElementById('konsult-content');
            
            // Populate konsult selector
            const owners = [...new Set(deals.map(d => d.owner))].sort();
            if (selector.options.length === 1) { // Only default option
                owners.forEach(owner => {
                    const option = document.createElement('option');
                    option.value = owner;
                    option.textContent = owner;
                    selector.appendChild(option);
                });
            }
            
            const selectedOwner = selector.value;
            if (!selectedOwner) {
                content.classList.add('hidden');
                return;
            }
            
            content.classList.remove('hidden');
            document.getElementById('konsult-name').textContent = selectedOwner;
            
            // Konsult's deals
            const myDeals = deals.filter(d => d.owner === selectedOwner && d.stage !== 'Tappat uppdrag');
            const dealsHtml = myDeals.length > 0
                ? myDeals.map(renderDealCard).join('')
                : '<div class="empty-state"><p>Inga aktiva deals</p></div>';
            document.getElementById('konsult-deals').innerHTML = dealsHtml;
            
            // Today's actions
            const actions = [];
            myDeals.forEach(deal => {
                const days = daysSince(deal.lastActivity);
                if (days > 14 && !deal.nextStep) {
                    actions.push({
                        icon: '‚ö†Ô∏è',
                        title: `F√∂lj upp ${deal.company}`,
                        desc: `${days} dagar sen senaste aktivitet. Boka uppf√∂ljningsm√∂te.`
                    });
                }
                if (deal.stage === 'Tut!' || deal.stage === 'Skarpt l√§ge') {
                    actions.push({
                        icon: 'üî•',
                        title: `${deal.company} √§r hot!`,
                        desc: `S√§kerst√§ll att du har case och n√§sta steg klart.`
                    });
                }
            });
            
            const actionsHtml = actions.length > 0
                ? actions.map(a => `
                    <li class="action-item">
                        <span class="action-icon">${a.icon}</span>
                        <div class="action-content">
                            <div class="action-title">${a.title}</div>
                            <div class="action-desc">${a.desc}</div>
                        </div>
                    </li>
                `).join('')
                : '<li class="action-item"><span class="action-icon">‚úÖ</span><div class="action-content"><div class="action-title">Allt ser bra ut!</div><div class="action-desc">Inga kritiska actions idag.</div></div></li>';
            
            document.getElementById('konsult-today').innerHTML = actionsHtml;
            
            // Network (placeholder)
            document.getElementById('konsult-network').innerHTML = `
                <div class="insight-box">
                    <h4>üåê Ditt N√§tverk</h4>
                    <p><em>Ladda upp dina LinkedIn-kontakter f√∂r personliga network insights</em></p>
                </div>
            `;
        }

        // Update Ledning View
        function updateLedningView() {
            const activeDeals = deals.filter(d => d.stage !== 'Tappat uppdrag');
            
            // Avg deal value
            const avgDeal = activeDeals.length > 0
                ? activeDeals.reduce((sum, d) => sum + d.value, 0) / activeDeals.length
                : 0;
            document.getElementById('ledning-avg-deal').textContent = formatCurrency(avgDeal);
            
            // Avg cycle time
            const avgCycle = activeDeals.length > 0
                ? activeDeals.reduce((sum, d) => sum + daysSince(d.created), 0) / activeDeals.length
                : 0;
            document.getElementById('ledning-cycle-time').textContent = Math.round(avgCycle) + ' dagar';
            
            // Service breakdown
            const serviceMap = {};
            activeDeals.forEach(d => {
                const service = d.service || '√ñvrigt';
                serviceMap[service] = (serviceMap[service] || 0) + d.value;
            });
            
            const serviceHtml = Object.entries(serviceMap)
                .sort((a, b) => b[1] - a[1])
                .map(([service, value]) => `
                    <div class="insight-box">
                        <strong>${service}:</strong> ${formatCurrency(value)}
                    </div>
                `).join('');
            document.getElementById('service-breakdown').innerHTML = serviceHtml || '<p>Ingen data √§n</p>';
            
            // Consultant breakdown
            const consultantMap = {};
            activeDeals.forEach(d => {
                consultantMap[d.owner] = (consultantMap[d.owner] || 0) + d.value;
            });
            
            const consultantHtml = Object.entries(consultantMap)
                .sort((a, b) => b[1] - a[1])
                .map(([owner, value]) => `
                    <div class="insight-box">
                        <strong>${owner}:</strong> ${formatCurrency(value)}
                    </div>
                `).join('');
            document.getElementById('consultant-breakdown').innerHTML = consultantHtml || '<p>Ingen data √§n</p>';
            
            // Leakage analysis
            const staleDeals = activeDeals.filter(d => daysSince(d.lastActivity) > 60);
            const noNextStep = activeDeals.filter(d => !d.nextStep);
            
            const leakageHtml = `
                <div class="insight-box warning">
                    <h4>‚ö†Ô∏è ${staleDeals.length} deals utan aktivitet >60 dagar</h4>
                    <p>V√§rde i risk: ${formatCurrency(staleDeals.reduce((sum, d) => sum + d.value, 0))}</p>
                </div>
                <div class="insight-box warning">
                    <h4>‚ö†Ô∏è ${noNextStep.length} deals utan planerat n√§sta steg</h4>
                    <p>Deals utan next step d√∂r ofta i tysthet.</p>
                </div>
            `;
            document.getElementById('leakage-analysis').innerHTML = leakageHtml;
            
            // Recommendations
            const recommendations = [];
            
            if (staleDeals.length > 0) {
                recommendations.push(`
                    <div class="learning-item">
                        <strong>1. Fix stale deals</strong><br>
                        ${staleDeals.length} deals beh√∂ver omedelbar aktivitet. Prioritera uppf√∂ljning.
                    </div>
                `);
            }
            
            if (noNextStep.length > activeDeals.length * 0.3) {
                recommendations.push(`
                    <div class="learning-item">
                        <strong>2. F√∂rb√§ttra next-step discipline</strong><br>
                        ${Math.round(noNextStep.length / activeDeals.length * 100)}% av deals saknar n√§sta steg. 
                        Implementera regel: Alltid boka n√§sta m√∂te under nuvarande m√∂te.
                    </div>
                `);
            }
            
            document.getElementById('strategic-recommendations').innerHTML = 
                recommendations.length > 0 ? recommendations.join('') : '<p>Ser bra ut! Forts√§tt som ni g√∂r.</p>';
        }

        // Update Retro View
        function updateRetroView() {
            const wonDeals = deals.filter(d => d.stage === 'Vunnen' || (d.value > 0 && d.stage === 'Tut!'));
            const lostDeals = deals.filter(d => d.stage === 'Tappat uppdrag');
            
            // Wins
            const winsHtml = wonDeals.length > 0
                ? wonDeals.map(deal => `
                    <div class="learning-item">
                        <strong>${deal.company}</strong> - ${formatCurrency(deal.value)}<br>
                        Service: ${deal.service || '‚Äî'}<br>
                        Owner: ${deal.owner}<br>
                        Cycle: ${daysSince(deal.created)} dagar
                    </div>
                `).join('')
                : '<p>Ingen vunnen deal registrerad √§n</p>';
            document.getElementById('retro-wins').innerHTML = winsHtml;
            
            // Losses
            const lossesHtml = lostDeals.length > 0
                ? lostDeals.map(deal => `
                    <div class="learning-item" style="border-left-color: #ef4444;">
                        <strong>${deal.company}</strong> - ${formatCurrency(deal.value)}<br>
                        Service: ${deal.service || '‚Äî'}<br>
                        Anledning: ${deal.comment || 'Inte specificerat'}
                    </div>
                `).join('')
                : '<p>Ingen f√∂rlorad deal registrerad √§n</p>';
            document.getElementById('retro-losses').innerHTML = lossesHtml;
            
            // Learnings
            const learnings = [];
            
            if (wonDeals.length > 0) {
                const avgWonValue = wonDeals.reduce((sum, d) => sum + d.value, 0) / wonDeals.length;
                learnings.push(`<div class="learning-item">
                    <strong>Genomsnittligt vunnet deal:</strong> ${formatCurrency(avgWonValue)}
                </div>`);
            }
            
            if (lostDeals.length > 0) {
                learnings.push(`<div class="learning-item">
                    <strong>F√∂rlorade deals:</strong> ${lostDeals.length} st. Analysera varf√∂r f√∂r att f√∂rb√§ttra win-rate.
                </div>`);
            }
            
            const staleDeals = deals.filter(d => d.stage !== 'Tappat uppdrag' && daysSince(d.lastActivity) > 60);
            if (staleDeals.length > 0) {
                learnings.push(`<div class="learning-item" style="border-left-color: #f59e0b;">
                    <strong>Pattern:</strong> Deals utan aktivitet >60 dagar har h√∂g risk att d√∂. 
                    ${staleDeals.length} deals i denna kategori just nu.
                </div>`);
            }
            
            document.getElementById('retro-learnings').innerHTML = 
                learnings.length > 0 ? learnings.join('') : '<p>Samla mer data f√∂r insights</p>';
            
            // Focus
            const focus = [];
            if (staleDeals.length > 0) {
                focus.push(`<li>Aktivera ${staleDeals.length} stale deals</li>`);
            }
            focus.push(`<li>Dokumentera vad som funkar i vunna deals</li>`);
            focus.push(`<li>Analysera f√∂rluster f√∂r att f√∂rb√§ttra approach</li>`);
            
            document.getElementById('retro-focus').innerHTML = '<ul style="margin-left: 20px;">' + focus.join('') + '</ul>';
        }

        // Update all views
        function updateAllViews() {
            updatePipelineView();
            updateTeamView();
            updateKonsultView();
            updateLedningView();
            updateRetroView();
        }

        // Delete deal
        function deleteDeal(id) {
            if (confirm('√Ñr du s√§ker p√• att du vill radera denna deal?')) {
                deals = deals.filter(d => d.id !== id);
                saveData();
                updateAllViews();
            }
        }

        // Edit deal (placeholder)
        function editDeal(id) {
            alert('Edit-funktionalitet kommer snart! F√∂r nu: radera och skapa ny.');
        }

        // Export data
        function exportData() {
            const dataStr = JSON.stringify(deals, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'doings-deals-' + new Date().toISOString().split('T')[0] + '.json';
            link.click();
        }

        // CSV Import/Export
        let pendingCSVDeals = [];

        // Import CSV
        function importCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const parsed = parseCSV(csv);
                    
                    if (parsed.length === 0) {
                        alert('Kunde inte hitta n√•gra deals i CSV-filen');
                        return;
                    }
                    
                    pendingCSVDeals = parsed;
                    showCSVPreview(parsed);
                    
                } catch (err) {
                    alert('Fel vid CSV-import: ' + err.message);
                    console.error(err);
                }
            };
            reader.readAsText(file, 'UTF-8');
        }

        // Parse CSV and map to our data structure
        function parseCSV(csv) {
            const lines = csv.split('\n').filter(line => line.trim());
            if (lines.length < 2) return [];
            
            // Parse header
            const header = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
            
            // Map column names to our fields
            const columnMap = {
                'Kund': 'company',
                'company': 'company',
                'f√∂retag': 'company',
                '40000': 'value',
                'v√§rde': 'value',
                'value': 'value',
                'deal-v√§rde': 'value',
                'Stage': 'stage',
                'stage': 'stage',
                'Uppdrag (rubrik)': 'service',
                'service': 'service',
                'typ av uppdrag': 'service',
                'Kontaktperson': 'contact',
                'kontakt': 'contact',
                'contact': 'contact',
                'Deal owner': 'owner',
                'owner': 'owner',
                '√§gare': 'owner',
                'Kommentar/status': 'comment',
                'kommentar': 'comment',
                'status': 'comment'
            };
            
            const deals = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                if (!line.trim()) continue;
                
                // Parse CSV line (handle quoted fields)
                const values = [];
                let current = '';
                let inQuotes = false;
                
                for (let char of line) {
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim());
                
                const deal = {
                    id: Date.now() + i,
                    company: '',
                    value: 0,
                    stage: 'Kundsnack',
                    owner: '',
                    service: '',
                    contact: '',
                    problem: '',
                    nextStep: '',
                    comment: '',
                    other: '',
                    lastActivity: new Date().toISOString().split('T')[0],
                    created: new Date().toISOString()
                };
                
                // Map values
                for (let j = 0; j < header.length && j < values.length; j++) {
                    const colName = header[j];
                    const value = values[j].replace(/^"|"$/g, '').trim();
                    
                    if (!value) continue;
                    
                    const mappedField = columnMap[colName];
                    
                    if (mappedField === 'company') {
                        deal.company = value;
                    } else if (mappedField === 'value') {
                        // Parse value - could be "2-3 mkr", "180 000", etc
                        const valueMatch = value.match(/(\d+(?:[,\s]\d+)?)/);
                        if (valueMatch) {
                            let numValue = valueMatch[1].replace(/[\s,]/g, '');
                            if (value.toLowerCase().includes('mkr') || value.toLowerCase().includes('miljon')) {
                                deal.value = parseInt(numValue) * 1000000;
                            } else if (value.toLowerCase().includes('k') || value.toLowerCase().includes('tusen')) {
                                deal.value = parseInt(numValue) * 1000;
                            } else {
                                deal.value = parseInt(numValue);
                            }
                        }
                    } else if (mappedField === 'stage') {
                        deal.stage = value;
                    } else if (mappedField === 'owner') {
                        deal.owner = value;
                    } else if (mappedField === 'service') {
                        deal.service = value;
                    } else if (mappedField === 'contact') {
                        deal.contact = value;
                    } else if (mappedField === 'comment') {
                        deal.comment = value;
                    } else {
                        // Unknown column -> add to "other"
                        if (deal.other) deal.other += '\n';
                        deal.other += `${colName}: ${value}`;
                    }
                }
                
                // Only add if we have at least company
                if (deal.company) {
                    deals.push(deal);
                }
            }
            
            return deals;
        }

        // Show CSV preview
        function showCSVPreview(deals) {
            const preview = document.getElementById('csv-preview');
            const content = document.getElementById('csv-preview-content');
            
            let html = `
                <div style="margin-bottom: 15px; font-weight: 600;">
                    Hittade ${deals.length} deals i CSV-filen
                </div>
                <div style="max-height: 400px; overflow-y: auto;">
            `;
            
            deals.slice(0, 5).forEach(deal => {
                html += `
                    <div style="padding: 15px; background: white; border-radius: 8px; margin-bottom: 10px; border: 2px solid #e5e7eb;">
                        <strong>${deal.company}</strong> - ${formatCurrency(deal.value)}<br>
                        Stage: ${deal.stage} | Owner: ${deal.owner}<br>
                        ${deal.service ? `Service: ${deal.service}<br>` : ''}
                        ${deal.comment ? `Kommentar: ${deal.comment.substring(0, 100)}...<br>` : ''}
                    </div>
                `;
            });
            
            if (deals.length > 5) {
                html += `<div style="text-align: center; color: #6b7280; margin-top: 10px;">
                    ... och ${deals.length - 5} deals till
                </div>`;
            }
            
            html += '</div>';
            
            content.innerHTML = html;
            preview.classList.remove('hidden');
        }

        // Confirm CSV import
        function confirmCSVImport() {
            if (!pendingCSVDeals || pendingCSVDeals.length === 0) return;
            
            const importMode = confirm(
                `Importera ${pendingCSVDeals.length} deals.\n\n` +
                `Klicka OK f√∂r att L√ÑGGA TILL deals (beh√•ller befintliga)\n` +
                `Klicka Avbryt f√∂r att g√• tillbaka`
            );
            
            if (importMode) {
                // Add to existing deals
                deals = [...deals, ...pendingCSVDeals];
            } else {
                return;
            }
            
            saveData();
            
            document.getElementById('csv-preview').classList.add('hidden');
            pendingCSVDeals = [];
            
            alert(`${pendingCSVDeals.length} deals importerade!`);
            updateAllViews();
            
            // Switch to pipeline view
            document.querySelector('.tab').click();
        }

        // Cancel CSV import
        function cancelCSVImport() {
            document.getElementById('csv-preview').classList.add('hidden');
            pendingCSVDeals = [];
        }

        // Export as CSV
        function exportCSV() {
            if (deals.length === 0) {
                alert('Inga deals att exportera');
                return;
            }
            
            // CSV header
            let csv = 'F√∂retag,V√§rde,Stage,Owner,Service,Kontakt,Senaste Aktivitet,N√§sta Steg,Problem,Kommentar,√ñvrigt\n';
            
            // Add rows
            deals.forEach(deal => {
                const row = [
                    escapeCSV(deal.company),
                    deal.value,
                    escapeCSV(deal.stage),
                    escapeCSV(deal.owner),
                    escapeCSV(deal.service),
                    escapeCSV(deal.contact),
                    deal.lastActivity,
                    escapeCSV(deal.nextStep),
                    escapeCSV(deal.problem),
                    escapeCSV(deal.comment),
                    escapeCSV(deal.other)
                ];
                csv += row.join(',') + '\n';
            });
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'doings-pipeline-' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
        }

        // Escape CSV field
        function escapeCSV(field) {
            if (!field) return '';
            const str = String(field);
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                return '"' + str.replace(/"/g, '""') + '"';
            }
            return str;
        }

        // Import data
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (confirm(`Importera ${imported.length} deals? Detta kommer ers√§tta nuvarande data.`)) {
                        deals = imported;
                        saveData();
                        updateAllViews();
                        alert('Data importerad!');
                    }
                } catch (err) {
                    alert('Fel vid import: ' + err.message);
                }
            };
            reader.readAsText(file);
        }

        // Load sample data
        function loadSampleData() {
            if (!confirm('Ladda exempeldata? Detta kommer l√§gga till flera exempel-deals.')) return;
            
            const sampleDeals = [
                {
                    id: Date.now() + 1,
                    company: 'Mojang AB',
                    value: 2500000,
                    stage: 'Tut!',
                    owner: 'Emma',
                    service: 'Ledarutveckling + OneBrand',
                    contact: 'Maria Svensson (Head of HR)',
                    lastActivity: '2026-01-15',
                    nextStep: 'Pitch p√• torsdag 23 jan',
                    comment: 'Vi ska pitcha tillsammans med tv√• andra leverant√∂rer men de vill jobba med oss',
                    problem: 'V√§xer snabbt, beh√∂ver st√§rka kultur och ledarskap',
                    created: '2025-12-01'
                },
                {
                    id: Date.now() + 2,
                    company: 'H&M Brand',
                    value: 450000,
                    stage: 'Kundsnack',
                    owner: 'Jennifer',
                    service: 'Ledarutveckling',
                    contact: 'Per Lindroth',
                    lastActivity: '2025-11-13',
                    nextStep: '',
                    comment: 'Ny konstellation i LG, kanske aktuellt Q1 2026',
                    problem: 'Ny ledargrupp beh√∂ver utvecklas',
                    created: '2025-11-01'
                },
                {
                    id: Date.now() + 3,
                    company: 'Volvo Cars',
                    value: 380000,
                    stage: 'Skarpt l√§ge',
                    owner: 'Marcus',
                    service: 'OneBrand + Kultur',
                    contact: 'Anna Berg (L&D)',
                    lastActivity: '2026-01-10',
                    nextStep: 'Discovery-m√∂te 25 jan',
                    comment: 'Warm intro via Marcus n√§tverk fungerade!',
                    problem: 'Tech-teams f√∂rlorar kultur i hybrid work',
                    created: '2026-01-05'
                },
                {
                    id: Date.now() + 4,
                    company: 'Aleris',
                    value: 180000,
                    stage: 'Skriver/skickat offert',
                    owner: 'Eva',
                    service: 'Ledarskapscoaching',
                    contact: 'HR-chef',
                    lastActivity: '2026-01-08',
                    nextStep: 'Uppf√∂ljning offert',
                    comment: 'Offert skickad, v√§ntar p√• svar',
                    problem: 'Nya chefer beh√∂ver st√∂d',
                    created: '2025-12-15'
                },
                {
                    id: Date.now() + 5,
                    company: 'Espresso House',
                    value: 180000,
                    stage: 'Tappat uppdrag',
                    owner: 'Anna',
                    service: 'HR Tech',
                    contact: 'Lisa',
                    lastActivity: '2025-11-20',
                    nextStep: '',
                    comment: 'De ville ha tech-leverant√∂r, vi passade inte',
                    problem: 'Ville mappa processer i HR-system',
                    created: '2025-10-15'
                }
            ];
            
            deals = [...deals, ...sampleDeals];
            saveData();
            updateAllViews();
            alert('Exempeldata laddad!');
        }
    </script>
</body>
</html>
