<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doings Sales Intelligence</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            color: #6b7280;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .tabs {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 30px;
        }

        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1.1em;
            color: #6b7280;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 600;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            background: #f9fafb;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #e5e7eb;
        }

        .section h2 {
            color: #1f2937;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .section h3 {
            color: #374151;
            margin-bottom: 15px;
            margin-top: 20px;
            font-size: 1.2em;
        }

        input[type="text"], input[type="number"], input[type="date"], select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            margin-bottom: 15px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        button {
            padding: 12px 25px;
            font-size: 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .primary-btn {
            background: #667eea;
            color: white;
        }

        .primary-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.4);
        }

        .secondary-btn {
            background: #e0e0e0;
            color: #333;
            margin-left: 10px;
        }

        .success-btn {
            background: #22c55e;
            color: white;
        }

        .danger-btn {
            background: #ef4444;
            color: white;
        }

        .deal-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .deal-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .deal-card.hot {
            border-left-color: #ef4444;
            background: #fef2f2;
        }

        .deal-card.stale {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }

        .deal-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .deal-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #1f2937;
        }

        .deal-value {
            font-size: 1.2em;
            font-weight: 700;
            color: #667eea;
        }

        .deal-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #6b7280;
            font-size: 0.95em;
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge.stage-cold {
            background: #f3f4f6;
            color: #6b7280;
        }

        .badge.stage-warm {
            background: #fef3c7;
            color: #92400e;
        }

        .badge.stage-contact {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge.stage-meeting {
            background: #e0e7ff;
            color: #3730a3;
        }

        .badge.stage-needs {
            background: #e0e7ff;
            color: #5b21b6;
        }

        .badge.stage-offer {
            background: #fef3c7;
            color: #92400e;
        }

        .badge.stage-negotiation {
            background: #fed7aa;
            color: #9a3412;
        }

        .badge.stage-ongoing {
            background: #dcfce7;
            color: #166534;
        }

        .badge.stage-won {
            background: #bbf7d0;
            color: #14532d;
        }

        .badge.stage-lost {
            background: #fee2e2;
            color: #991b1b;
        }

        .insight-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .insight-box.warning {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }

        .insight-box.success {
            border-left-color: #22c55e;
            background: #f0fdf4;
        }

        .insight-box h4 {
            color: #1f2937;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.95em;
        }

        .action-list {
            list-style: none;
            padding: 0;
        }

        .action-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 2px solid #e5e7eb;
        }

        .action-icon {
            font-size: 1.5em;
        }

        .action-content {
            flex: 1;
        }

        .action-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .action-desc {
            color: #6b7280;
            font-size: 0.9em;
        }

        .hidden {
            display: none;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .chart-placeholder {
            background: #f3f4f6;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            color: #6b7280;
            font-style: italic;
        }

        .network-match {
            background: #eff6ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            border: 2px solid #3b82f6;
        }

        .ai-suggestion {
            background: linear-gradient(135deg, #667eea22 0%, #764ba222 100%);
            padding: 20px;
            border-radius: 12px;
            margin-top: 15px;
            border: 2px solid #667eea;
        }

        .ai-suggestion h4 {
            color: #667eea;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .deal-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .empty-state h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .retro-section {
            margin-bottom: 30px;
        }

        .learning-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #22c55e;
        }

        .stage-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9fafb;
            border-radius: 12px;
            border: 2px solid #e5e7eb;
        }

        .stage-section h3 {
            margin-bottom: 15px;
            color: #1f2937;
            font-size: 1.2em;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }

        .stage-empty {
            padding: 20px;
            text-align: center;
            color: #9ca3af;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Doings Sales Intelligence</h1>
        <p class="subtitle">Sales Intelligence Platform</p>

        <div class="tabs">
            <button class="tab active" onclick="showTab('pipeline')">Pipeline</button>
            <button class="tab" onclick="showTab('team')">Team</button>
            <button class="tab" onclick="showTab('kunder')">Kunder</button>
            <button class="tab" onclick="showTab('konsult')">Konsult</button>
            <button class="tab" onclick="showTab('ledning')">Analys</button>
            <button class="tab" onclick="showTab('input')">Lägg till</button>
        </div>

        <!-- PIPELINE VY (HUVUDVY) -->
        <div id="pipeline-view" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="pipeline-total-value">0 kr</div>
                    <div class="stat-label">Total Pipeline</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="pipeline-deal-count">0</div>
                    <div class="stat-label">Antal Deals</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="pipeline-avg-value">0 kr</div>
                    <div class="stat-label">Genomsnitt per Deal</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="pipeline-data-quality">0%</div>
                    <div class="stat-label">Data Quality</div>
                </div>
            </div>

            <!-- FILTERS -->
            <div class="section" style="background: white; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;">Filtrera Pipeline</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="filter-missing-contact" onchange="applyFilters()">
                        Saknar kontaktperson
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="filter-missing-next" onchange="applyFilters()">
                        Saknar nästa steg
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="filter-missing-value" onchange="applyFilters()">
                        Saknar värde
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="filter-missing-kam" onchange="applyFilters()">
                        Saknar KAM
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="filter-incomplete" onchange="applyFilters()">
                        Ofullständig data (under 50%)
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="filter-complete" onchange="applyFilters()">
                        Komplett data (över 80%)
                    </label>
                </div>
                <div style="margin-top: 15px;">
                    <label>Filtrera på konsult:</label>
                    <select id="filter-owner" onchange="applyFilters()" style="margin-left: 10px; padding: 8px;">
                        <option value="">Alla</option>
                    </select>
                    <label style="margin-left: 20px;">Filtrera på stage:</label>
                    <select id="filter-stage" onchange="applyFilters()" style="margin-left: 10px; padding: 8px;">
                        <option value="">Alla</option>
                        <option value="Prospekt - Kall">Prospekt - Kall</option>
                        <option value="Prospekt - Varm">Prospekt - Varm</option>
                        <option value="Första kontakt">Första kontakt</option>
                        <option value="Möte bokat">Möte bokat</option>
                        <option value="Behovskartläggning">Behovskartläggning</option>
                        <option value="Offert">Offert</option>
                        <option value="Förhandling">Förhandling</option>
                        <option value="Pågående uppdrag">Pågående uppdrag</option>
                        <option value="Vunnen">Vunnen</option>
                        <option value="Förlorad">Förlorad</option>
                    </select>
                    <button class="secondary-btn" onclick="clearFilters()" style="margin-left: 10px;">Rensa filter</button>
                </div>
            </div>

            <!-- ALLA DEALS -->
            <div class="section">
                <h2>Alla Deals</h2>
                <div id="all-deals" class="deal-list"></div>
            </div>
        </div>

        <!-- TEAM VY -->
        <div id="team-view" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="team-total-value">0 kr</div>
                    <div class="stat-label">Total Pipeline</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="team-deal-count">0</div>
                    <div class="stat-label">Aktiva Deals</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="team-hot-count">0</div>
                    <div class="stat-label">Heta Deals</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="team-stale-count">0</div>
                    <div class="stat-label">Risk Deals</div>
                </div>
            </div>

            <div class="section">
                <h2>Skarpa lägen just nu</h2>
                <div id="hot-deals" class="deal-list"></div>
            </div>

            <div class="section">
                <h2>Står stilla för länge</h2>
                <div id="stale-deals" class="deal-list"></div>
            </div>

            <div class="section">
                <h2>Kan vi hjälpa varandra?</h2>
                <div id="network-opportunities"></div>
            </div>

            <div class="section">
                <h2>Alla Deals</h2>
                <div id="all-deals" class="deal-list"></div>
            </div>
        </div>

        <!-- KUNDER VY -->
        <div id="kunder-view" class="tab-content">
            <div class="section">
                <h2>Befintliga Kunder</h2>
                <p style="color: #6b7280; margin-bottom: 20px;">
                    Översikt av alla kunder vi redan jobbar med. Historik, omsättning, och vem som är ansvarig.
                </p>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="kunder-total">0</div>
                        <div class="stat-label">Antal kunder</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="kunder-revenue">0 kr</div>
                        <div class="stat-label">Total omsättning</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="kunder-avg">0 kr</div>
                        <div class="stat-label">Snitt per kund</div>
                    </div>
                </div>

                <div id="customer-list" style="margin-top: 30px;"></div>
            </div>
        </div>

        <!-- KONSULT VY -->
        <div id="konsult-view" class="tab-content">
            <div class="section">
                <h2>Välj Konsult</h2>
                <select id="konsult-selector" onchange="updateKonsultView()">
                    <option value="">Välj konsult...</option>
                </select>
            </div>

            <div id="konsult-content" class="hidden">
                <div class="section">
                    <h2> Hej <span id="konsult-name"></span>!</h2>
                    
                    <h3> Idag</h3>
                    <ul class="action-list" id="konsult-today"></ul>

                    <h3>Dina Deals</h3>
                    <div id="konsult-deals"></div>

                    <h3> Ditt Nätverk Kan Hjälpa</h3>
                    <div id="konsult-network"></div>
                </div>
            </div>
        </div>

        <!-- LEDNING VY -->
        <div id="ledning-view" class="tab-content">
            <div class="section">
                <h2>Översikt</h2>
                
                <h3>Siffror</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="ledning-avg-deal">0 kr</div>
                        <div class="stat-label">Snitt per deal</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="ledning-cycle-time">0</div>
                        <div class="stat-label">Snitt antal dagar per deal</div>
                    </div>
                </div>

                <h3>Fördelning per tjänst</h3>
                <div id="service-breakdown"></div>

                <h3>Fördelning per konsult</h3>
                <div id="consultant-breakdown"></div>

                <h3>Problem</h3>
                <div id="leakage-analysis"></div>

                <h3>Förslag</h3>
                <div id="strategic-recommendations"></div>
            </div>
        </div>

        <!-- RETRO VY -->
        <div id="retro-view" class="tab-content">
            <div class="section">
                <h2> Collective Learning</h2>
                
                <div class="retro-section">
                    <h3>Vunna Deals</h3>
                    <div id="retro-wins"></div>
                </div>

                <div class="retro-section">
                    <h3> Förlorade Deals</h3>
                    <div id="retro-losses"></div>
                </div>

                <div class="retro-section">
                    <h3> Lärdomar</h3>
                    <div id="retro-learnings"></div>
                </div>

                <div class="retro-section">
                    <h3> Nästa Månad - Fokus På</h3>
                    <div id="retro-focus"></div>
                </div>
            </div>
        </div>

        <!-- INPUT VY -->
        <div id="input-view" class="tab-content">
            <div class="section">
                <h2>Lägg till Deal</h2>
                
                <!-- AI INPUT SEKTION -->
                <div style="background: #f0f9ff; padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 2px solid #3b82f6;">
                    <h3 style="margin-bottom: 15px; color: #1e40af;">Snabbt lägg till med AI</h3>
                    <p style="color: #1e40af; margin-bottom: 15px; font-size: 0.95em;">
                        Berätta vad som hände - AI:n fyller i fälten nedan automatiskt
                    </p>
                    
                    <textarea 
                        id="ai-input" 
                        placeholder="Exempel: 'Träffade Anna på Volvo idag. De behöver hjälp med ledarutveckling för sina tech-teams. Cirka 400k. Vi är i tidigt snack-läge.'"
                        style="min-height: 100px; font-size: 15px; width: 100%; margin-bottom: 15px;"
                    ></textarea>

                    <div style="display: flex; gap: 10px;">
                        <button class="primary-btn" onclick="fillFormWithAI()" id="ai-fill-btn">
                            <span id="ai-fill-text">Fyll i fält med AI</span>
                        </button>
                        <button class="secondary-btn" onclick="startVoiceInput()" id="voice-btn">
                            <span id="voice-btn-text"> Tala in</span>
                        </button>
                        <button class="secondary-btn" onclick="clearAIInput()">
                            Rensa
                        </button>
                    </div>
                </div>

                <!-- FORMULÄR (ALLTID SYNLIGT) -->
                <form id="deal-form" onsubmit="saveDeal(event)">
                    <div class="form-row">
                        <div>
                            <label>Företag *</label>
                            <input type="text" id="company" required placeholder="t.ex. Mojang AB">
                        </div>
                        <div>
                            <label>Deal-värde (kr)</label>
                            <input type="number" id="value" placeholder="t.ex. 250000">
                        </div>
                    </div>

                    <div class="form-row">
                        <div>
                            <label>Stage *</label>
                            <select id="stage" required>
                                <option value="">Välj stage...</option>
                                <option value="Prospekt - Kall">Prospekt - Kall</option>
                                <option value="Prospekt - Varm">Prospekt - Varm</option>
                                <option value="Första kontakt">Första kontakt</option>
                                <option value="Möte bokat">Möte bokat</option>
                                <option value="Behovskartläggning">Behovskartläggning</option>
                                <option value="Offert">Offert</option>
                                <option value="Förhandling">Förhandling</option>
                                <option value="Pågående uppdrag">Pågående uppdrag</option>
                                <option value="Vunnen">Vunnen</option>
                                <option value="Förlorad">Förlorad</option>
                            </select>
                        </div>
                        <div>
                            <label>Mognadsgrad</label>
                            <select id="confidence">
                                <option value="">Välj...</option>
                                <option value="1">1 - Möte</option>
                                <option value="2">2 - Hett möte</option>
                                <option value="3">3 - Bekräftad affär</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div>
                            <label>Deal Owner *</label>
                            <input type="text" id="owner" required placeholder="t.ex. Emma">
                        </div>
                        <div>
                            <label>KAM (Key Account Manager)</label>
                            <input type="text" id="kam" placeholder="Vem är ansvarig för relationen långsiktigt?">
                        </div>
                    </div>

                    <div class="form-row">
                        <div>
                            <label>Typ av Uppdrag</label>
                            <input type="text" id="service" placeholder="t.ex. Ledarutveckling, OneBrand, Coaching">
                        </div>
                        <div>
                            <label>Kundtyp</label>
                            <select id="customer-type">
                                <option value="">Välj...</option>
                                <option value="Enterprise">Enterprise (stor kund)</option>
                                <option value="Mid-market">Mid-market (mellanstora)</option>
                                <option value="SMB">SMB (små företag)</option>
                                <option value="Okänd">Okänd</option>
                            </select>
                        </div>
                    </div>

                    <label>Kontaktperson</label>
                    <input type="text" id="contact" placeholder="Namn och titel">

                    <div style="margin: 15px 0;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="existing-customer">
                            <span>Befintlig kund (har jobbat med oss tidigare)</span>
                        </label>
                    </div>

                    <label>Senaste Aktivitet</label>
                    <input type="date" id="last-activity">

                    <label>Nästa Steg</label>
                    <input type="text" id="next-step" placeholder="t.ex. Uppföljningsmöte 24 jan">

                    <label>Kommentar/Status</label>
                    <textarea id="comment" placeholder="Vad är läget? Vad hände senast?"></textarea>

                    <label>Problem/Behov (från kund)</label>
                    <textarea id="problem" placeholder="Vad är kundens utmaning? Vad vill de åstadkomma?"></textarea>

                    <label>Lärdomar</label>
                    <textarea id="learnings" placeholder="Vad har vi lärt oss i denna affär? Vad funkar/funkar inte?"></textarea>

                    <label>Övrigt</label>
                    <textarea id="other" placeholder="Annan information som inte passar i övriga fält"></textarea>

                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="submit" class="primary-btn">Lägg till Deal</button>
                        <button type="button" class="secondary-btn" onclick="clearForm()">Rensa formulär</button>
                    </div>
                </form>
            </div>

            <div class="section">
                <h2>Import/Export</h2>
                
                <h3 style="margin-bottom: 15px;">Importera från CSV (Slack säljpipe)</h3>
                <p style="color: #6b7280; margin-bottom: 15px; font-size: 0.95em;">
                    Ladda upp er säljpipe CSV-fil från Slack. Systemet mappar automatiskt kolumnerna.
                </p>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="primary-btn" onclick="document.getElementById('csv-file').click()">
                        Importera CSV
                    </button>
                    <button class="secondary-btn" onclick="downloadCSVTemplate()">
                        Ladda ner CSV-mall
                    </button>
                </div>
                <input type="file" id="csv-file" class="hidden" accept=".csv" onchange="importCSV(event)">
                
                <div id="csv-preview" class="hidden" style="margin-top: 20px; padding: 20px; background: #f9fafb; border-radius: 8px;">
                    <h4 style="margin-bottom: 10px;">Förhandsgranskning:</h4>
                    <div id="csv-preview-content" style="margin-bottom: 15px; max-height: 300px; overflow-y: auto;"></div>
                    <div style="display: flex; gap: 10px;">
                        <button class="success-btn" onclick="confirmCSVImport()">Importera dessa deals</button>
                        <button class="secondary-btn" onclick="cancelCSVImport()">Avbryt</button>
                    </div>
                </div>

                <h3 style="margin-top: 30px; margin-bottom: 15px;">Exportera/Backup</h3>
                <button class="secondary-btn" onclick="exportData()">Exportera Data (JSON)</button>
                <button class="secondary-btn" onclick="exportCSV()">Exportera som CSV</button>
                
                <h3 style="margin-top: 30px; margin-bottom: 15px;">Radera Data</h3>
                <p style="color: #6b7280; margin-bottom: 15px; font-size: 0.95em;">
                    Radera all data från systemet. Detta kan inte ångras!
                </p>
                <button class="danger-btn" onclick="deleteAllData()">Radera all data</button>
                
                <h3 style="margin-top: 30px; margin-bottom: 15px;">Testdata</h3>
                <button class="secondary-btn" onclick="document.getElementById('import-file').click()">Importera JSON</button>
                <button class="secondary-btn" onclick="loadSampleData()">Ladda Exempeldata</button>
                <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(event)">
            </div>
        </div>
    </div>

    <script>
        // Data storage
        let deals = [];
        let networks = []; // LinkedIn kontakter (placeholder för framtiden)

        // Load data från localStorage
        function loadData() {
            const saved = localStorage.getItem('doings-deals');
            if (saved) {
                deals = JSON.parse(saved);
            }
        }

        // Save data till localStorage
        function saveData() {
            localStorage.setItem('doings-deals', JSON.stringify(deals));
        }

        // AI Deal Processing
        let recognition = null;

        // Initialize speech recognition
        function initVoiceRecognition() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'sv-SE';
                
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('ai-input').value += (document.getElementById('ai-input').value ? ' ' : '') + transcript;
                    document.getElementById('voice-btn-text').textContent = ' Tala in';
                };
                
                recognition.onerror = function(event) {
                    alert('Röstinspelning misslyckades: ' + event.error);
                    document.getElementById('voice-btn-text').textContent = ' Tala in';
                };
                
                recognition.onend = function() {
                    document.getElementById('voice-btn-text').textContent = ' Tala in';
                };
            }
        }

        initVoiceRecognition();

        // Start voice input
        function startVoiceInput() {
            if (!recognition) {
                alert('Röstinspelning stöds inte i denna webbläsare. Prova Chrome.');
                return;
            }
            
            document.getElementById('voice-btn-text').textContent = ' Lyssnar...';
            recognition.start();
        }

        // Clear AI input
        function clearAIInput() {
            document.getElementById('ai-input').value = '';
        }

        // Fill form with AI
        async function fillFormWithAI() {
            const input = document.getElementById('ai-input').value.trim();
            
            if (!input) {
                alert('Skriv eller tala in information om dealen först');
                return;
            }
            
            const btn = document.getElementById('ai-fill-btn');
            btn.disabled = true;
            document.getElementById('ai-fill-text').textContent = 'AI analyserar...';
            
            try {
                const extracted = await extractDealInfo(input);
                
                // Fyll i formulärfält
                if (extracted.company) document.getElementById('company').value = extracted.company;
                if (extracted.value) document.getElementById('value').value = extracted.value;
                if (extracted.stage) document.getElementById('stage').value = extracted.stage;
                if (extracted.owner) document.getElementById('owner').value = extracted.owner;
                if (extracted.service) document.getElementById('service').value = extracted.service;
                if (extracted.contact) document.getElementById('contact').value = extracted.contact;
                if (extracted.nextStep) document.getElementById('next-step').value = extracted.nextStep;
                if (extracted.problem) document.getElementById('problem').value = extracted.problem;
                if (extracted.comment) document.getElementById('comment').value = extracted.comment;
                
                // Allt som inte passade i fält → Övrigt
                if (extracted.other) {
                    document.getElementById('other').value = extracted.other;
                }
                
                // Clear AI input efter framgångsrik extraktion
                document.getElementById('ai-input').value = '';
                
                // Scroll till formuläret
                document.getElementById('deal-form').scrollIntoView({ behavior: 'smooth', block: 'start' });
                
            } catch (error) {
                alert('Fel vid AI-analys: ' + error.message);
            } finally {
                btn.disabled = false;
                document.getElementById('ai-fill-text').textContent = 'Fyll i fält med AI';
            }
        }

        // Extract deal info using AI (simulated - replace with real Claude API call)
        async function extractDealInfo(text) {
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 800));
            
            const originalText = text;
            let remainingText = text;
            
            const deal = {
                company: null,
                value: 0,
                stage: 'Kundsnack',
                owner: 'Marcus', // Default
                service: null,
                contact: null,
                problem: null,
                nextStep: null,
                comment: null,
                other: null,
                lastActivity: new Date().toISOString().split('T')[0],
                created: new Date().toISOString()
            };
            
            // Extract company
            const companyPatterns = [
                /(?:träffade|möte med|pitch|hos|från)\s+([A-ZÅÄÖ][a-zåäö]+(?:\s+[A-ZÅÄÖ][A-Z]+)?)/i,
                /([A-ZÅÄÖ][a-zåäö]+(?:\s+[A-ZÅÄÖ][A-Z]+)?)/
            ];
            
            for (const pattern of companyPatterns) {
                const match = remainingText.match(pattern);
                if (match) {
                    deal.company = match[1];
                    remainingText = remainingText.replace(match[1], '');
                    break;
                }
            }
            
            // Extract value
            const valuePatterns = [
                /(\d+(?:[,\s]\d+)?)\s*(?:miljoner?|mkr)/i,
                /(\d+)\s*(?:tusen|k)\b/i,
                /(\d[\d\s]+)\s*kr/i
            ];
            
            for (const pattern of valuePatterns) {
                const match = remainingText.match(pattern);
                if (match) {
                    let value = match[1].replace(/[\s,]/g, '');
                    if (remainingText.toLowerCase().includes('miljon') || remainingText.toLowerCase().includes('mkr')) {
                        deal.value = parseInt(value) * 1000000;
                    } else if (remainingText.toLowerCase().includes('tusen') || remainingText.toLowerCase().includes('k')) {
                        deal.value = parseInt(value) * 1000;
                    } else {
                        deal.value = parseInt(value);
                    }
                    remainingText = remainingText.replace(match[0], '');
                    break;
                }
            }
            
            // Extract stage
            if (remainingText.match(/pitch|pitcha/i)) {
                deal.stage = 'Skarpt läge';
            } else if (remainingText.match(/offert|offererat/i)) {
                deal.stage = 'Skriver/skickat offert';
            } else if (remainingText.match(/nästan klar|vinn|beslutar snart|tut/i)) {
                deal.stage = 'Tut!';
            } else if (remainingText.match(/tappat|förlorat|valde annan/i)) {
                deal.stage = 'Tappat uppdrag';
            }
            
            // Extract service
            const services = {
                'ledarutveckling': 'Ledarutveckling',
                'onebrand': 'OneBrand',
                'coaching': 'Coaching',
                'kultur': 'Kultur',
                'workshop': 'Workshop'
            };
            
            for (const [key, value] of Object.entries(services)) {
                if (remainingText.toLowerCase().includes(key)) {
                    deal.service = value;
                    remainingText = remainingText.replace(new RegExp(key, 'gi'), '');
                    break;
                }
            }
            
            // Extract contact person
            const contactMatch = remainingText.match(/(?:träffade|med|kontakt)\s+([A-ZÅÄÖ][a-zåäö]+(?:\s+[A-ZÅÄÖ][a-zåäö]+)?)/);
            if (contactMatch) {
                deal.contact = contactMatch[1];
                remainingText = remainingText.replace(contactMatch[0], '');
            }
            
            // Extract problem/need
            const problemPatterns = [
                /behöver?\s+(.*?)(?:\.|,|$)/i,
                /vill\s+(.*?)(?:\.|,|$)/i,
                /problem.*?:\s*(.*?)(?:\.|,|$)/i
            ];
            
            for (const pattern of problemPatterns) {
                const match = remainingText.match(pattern);
                if (match) {
                    deal.problem = match[1].trim();
                    remainingText = remainingText.replace(match[0], '');
                    break;
                }
            }
            
            // Extract next step
            const nextStepPatterns = [
                /nästa\s+vecka/i,
                /återkomma/i,
                /bokat\s+möte/i,
                /beslutar/i,
                /uppföljning/i
            ];
            
            for (const pattern of nextStepPatterns) {
                const match = remainingText.match(pattern);
                if (match) {
                    const context = remainingText.substring(Math.max(0, match.index - 50), Math.min(remainingText.length, match.index + 100));
                    deal.nextStep = context.trim();
                    remainingText = remainingText.replace(context, '');
                    break;
                }
            }
            
            // What's left that's meaningful goes to "other"
            const cleaned = remainingText.replace(/\s+/g, ' ').trim();
            if (cleaned.length > 20) { // Only if there's substantial content left
                deal.other = cleaned;
            }
            
            // Original text as comment if we want to keep full context
            deal.comment = originalText;
            
            return deal;
        }

        // Save deal from form
        function saveDeal(event) {
            event.preventDefault();
            
            const confidenceValue = document.getElementById('confidence').value;
            
            const deal = {
                id: Date.now(),
                company: document.getElementById('company').value,
                value: parseInt(document.getElementById('value').value) || 0,
                stage: document.getElementById('stage').value,
                confidence: confidenceValue ? parseInt(confidenceValue) : null,
                owner: document.getElementById('owner').value,
                kam: document.getElementById('kam').value,
                customerType: document.getElementById('customer-type').value,
                service: document.getElementById('service').value,
                contact: document.getElementById('contact').value,
                existingCustomer: document.getElementById('existing-customer').checked,
                learnings: document.getElementById('learnings').value,
                lastActivity: document.getElementById('last-activity').value || new Date().toISOString().split('T')[0],
                nextStep: document.getElementById('next-step').value,
                comment: document.getElementById('comment').value,
                problem: document.getElementById('problem').value,
                other: document.getElementById('other').value,
                created: new Date().toISOString()
            };
            
            deals.push(deal);
            saveData();
            
            clearForm();
            alert('Deal sparad!');
            
            updateAllViews();
            
            // Switch to pipeline view
            document.querySelector('.tab').click();
        }

        // Clear form
        function clearForm() {
            document.getElementById('deal-form').reset();
            document.getElementById('ai-input').value = '';
        }

        // Initialize
        loadData();
        updateAllViews();

        // Tab switching
        function showTab(tabName) {
            // Ta bort active från alla flikar och innehåll
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));
            
            // Hitta och aktivera rätt flik baserat på tabName
            const tabMap = {
                'pipeline': 0,
                'team': 1,
                'kunder': 2,
                'konsult': 3,
                'ledning': 4,
                'input': 5
            };
            
            const tabIndex = tabMap[tabName];
            if (tabIndex !== undefined && tabs[tabIndex]) {
                tabs[tabIndex].classList.add('active');
            }
            
            // Visa rätt innehåll
            const viewElement = document.getElementById(tabName + '-view');
            if (viewElement) {
                viewElement.classList.add('active');
            }
            
            // Uppdatera vyer
            updateAllViews();
        }

        // Add deal
        function addDeal(event) {
            event.preventDefault();
            
            const deal = {
                id: Date.now(),
                company: document.getElementById('company').value,
                value: parseInt(document.getElementById('value').value) || 0,
                stage: document.getElementById('stage').value,
                owner: document.getElementById('owner').value,
                service: document.getElementById('service').value,
                contact: document.getElementById('contact').value,
                lastActivity: document.getElementById('last-activity').value || new Date().toISOString().split('T')[0],
                nextStep: document.getElementById('next-step').value,
                comment: document.getElementById('comment').value,
                problem: document.getElementById('problem').value,
                created: new Date().toISOString()
            };
            
            deals.push(deal);
            saveData();
            
            document.getElementById('deal-form').reset();
            alert('Deal tillagd!');
            
            updateAllViews();
        }

        // Calculate days since last activity
        function daysSince(dateStr) {
            const lastDate = new Date(dateStr);
            const today = new Date();
            const diff = today - lastDate;
            return Math.floor(diff / (1000 * 60 * 60 * 24));
        }

        // Format currency
        function formatCurrency(value) {
            if (!value) return '—';
            return new Intl.NumberFormat('sv-SE', { 
                style: 'decimal',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value) + ' kr';
        }

        // Get stage badge class
        function getStageBadgeClass(stage) {
            const map = {
                'Prospekt - Kall': 'stage-cold',
                'Prospekt - Varm': 'stage-warm',
                'Första kontakt': 'stage-contact',
                'Möte bokat': 'stage-meeting',
                'Behovskartläggning': 'stage-needs',
                'Offert': 'stage-offer',
                'Förhandling': 'stage-negotiation',
                'Pågående uppdrag': 'stage-ongoing',
                'Vunnen': 'stage-won',
                'Förlorad': 'stage-lost'
            };
            return map[stage] || 'stage-talk';
        }

        // Calculate data quality for a deal
        function calculateDataQuality(deal) {
            const requiredFields = [
                deal.company,
                deal.value > 0,
                deal.stage,
                deal.owner,
                deal.service,
                deal.contact,
                deal.nextStep,
                deal.problem
            ];
            
            // KAM är required för befintliga kunder och Pågående uppdrag
            if (deal.existingCustomer || deal.stage === 'Pågående uppdrag') {
                requiredFields.push(deal.kam);
            }
            
            const filled = requiredFields.filter(f => f && String(f).trim()).length;
            const percentage = Math.round((filled / requiredFields.length) * 100);
            
            const missing = []
                .concat(!deal.contact ? ['Kontaktperson'] : [])
                .concat(!deal.nextStep ? ['Nästa steg'] : [])
                .concat(!deal.value || deal.value === 0 ? ['Värde'] : [])
                .concat(!deal.problem ? ['Problem/behov'] : [])
                .concat(!deal.service ? ['Service'] : []);
            
            if ((deal.existingCustomer || deal.stage === 'Pågående uppdrag') && !deal.kam) {
                missing.push('KAM');
            }
            
            return {
                percentage: percentage,
                missing: missing
            };
        }

        // Render deal card
        function renderDealCard(deal) {
            const days = daysSince(deal.lastActivity);
            const isStale = days > 21;
            const isHot = deal.stage === 'Offert' || deal.stage === 'Förhandling' || deal.stage === 'Pågående uppdrag';
            
            const quality = calculateDataQuality(deal);
            
            let cardClass = 'deal-card';
            if (isHot) cardClass += ' hot';
            else if (isStale) cardClass += ' stale';
            
            // Confidence badge
            let confidenceBadge = '';
            if (deal.confidence) {
                const confLabels = {
                    1: 'Möte',
                    2: 'Hett möte',
                    3: 'Bekräftad affär'
                };
                confidenceBadge = `<span class="badge" style="background: #dbeafe; color: #1e40af; margin-left: 8px;">
                    ${confLabels[deal.confidence]}
                </span>`;
            }
            
            const aiInsights = generateAIInsights(deal);
            
            // Data quality indicator
            let qualityIndicator = '';
            if (quality.percentage < 50) {
                qualityIndicator = `<div style="padding: 10px; background: #fee2e2; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #ef4444;">
                    <strong>Data Quality: ${quality.percentage}% - Kritiskt ofullständig</strong><br>
                    Saknas: ${quality.missing.join(', ')}
                </div>`;
            } else if (quality.percentage < 80) {
                qualityIndicator = `<div style="padding: 10px; background: #fef3c7; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #f59e0b;">
                    <strong>Data Quality: ${quality.percentage}% - Kan förbättras</strong><br>
                    Saknas: ${quality.missing.join(', ')}
                </div>`;
            } else if (quality.missing.length > 0) {
                qualityIndicator = `<div style="padding: 8px; background: #f3f4f6; border-radius: 6px; margin-bottom: 10px; font-size: 0.9em;">
                    Data Quality: ${quality.percentage}% ${quality.missing.length > 0 ? `(saknas: ${quality.missing.join(', ')})` : ''}
                </div>`;
            }
            
            // AI Insights rendering
            let aiInsightsHtml = '';
            if (aiInsights.length > 0) {
                aiInsightsHtml = `
                    <div style="margin-top: 10px; padding: 10px; background: #eff6ff; border-radius: 6px;">
                        <strong>AI Insights:</strong>
                        ${aiInsights.map(insight => `
                            <div style="margin-top: 5px; padding: 5px; font-size: 0.9em;">
                                <strong>${insight.title}</strong><br>
                                ${insight.text}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            return `
                <div class="${cardClass}">
                    ${qualityIndicator}
                    <div class="deal-header">
                        <div>
                            <div class="deal-title">${deal.company}</div>
                            <span class="badge ${getStageBadgeClass(deal.stage)}">${deal.stage}</span>
                            ${confidenceBadge}
                            ${deal.existingCustomer ? '<span class="badge" style="background: #d1fae5; color: #065f46; margin-left: 8px;">Befintlig kund</span>' : ''}
                        </div>
                        <div class="deal-value">${formatCurrency(deal.value)}</div>
                    </div>
                    <div class="deal-meta">
                        <div class="meta-item">Owner: ${deal.owner}</div>
                        ${deal.kam ? `<div class="meta-item">KAM: ${deal.kam}</div>` : ''}
                        <div class="meta-item">Service: ${deal.service || '—'}</div>
                        <div class="meta-item">Senaste: ${days} dagar sedan</div>
                        ${deal.contact ? `<div class="meta-item">Kontakt: ${deal.contact}</div>` : ''}
                    </div>
                    ${deal.problem ? `<div style="margin-top: 10px;"><strong>Problem:</strong> ${deal.problem}</div>` : ''}
                    ${deal.nextStep ? `<div style="margin-top: 5px;"><strong>Nästa steg:</strong> ${deal.nextStep}</div>` : ''}
                    ${deal.comment ? `<div style="margin-top: 5px; color: #6b7280;"><strong>Kommentar:</strong> ${deal.comment}</div>` : ''}
                    ${deal.other ? `<div style="margin-top: 5px; color: #6b7280;"><strong>Övrigt:</strong> ${deal.other}</div>` : ''}
                    ${aiInsights ? `<div class="ai-suggestion">${aiInsights}</div>` : ''}
                    <div style="margin-top: 15px;">
                        <button class="secondary-btn" onclick="editDeal(${deal.id})">Redigera</button>
                        <button class="danger-btn" onclick="deleteDeal(${deal.id})">Radera</button>
                    </div>
                </div>
            `;
        }

        // Generate AI insights for a deal
        function generateAIInsights(deal) {
            const days = daysSince(deal.lastActivity);
            const insights = [];
            
            // KAM missing för aktiva kunder
            if (!deal.kam && (deal.stage === 'Pågående uppdrag' || deal.stage === 'Offert' || deal.stage === 'Förhandling' || deal.existingCustomer)) {
                insights.push({
                    type: 'warning',
                    title: 'Saknar KAM',
                    text: 'Tilldela Key Account Manager för långsiktig kundrelation'
                });
            }
            
            // Stale deal warning
            if (days > 21 && deal.stage !== 'Förlorad' && deal.stage !== 'Vunnen') {
                insights.push({
                    type: 'critical',
                    title: `${days} dagar utan aktivitet`,
                    text: 'Risk att dealen dör. Boka uppföljningsmöte NU.'
                });
            }
            
            // Next step missing
            if (!deal.nextStep && deal.stage !== 'Förlorad' && deal.stage !== 'Vunnen') {
                insights.push({
                    type: 'warning',
                    title: 'Saknar nästa steg',
                    text: 'Deals utan tydlig next action stannar ofta av.'
                });
            }
            
            // Offert follow-up
            if (deal.stage === 'Offert' && days > 7) {
                insights.push({
                    type: 'action',
                    title: 'Offert >7 dagar',
                    text: 'Följ upp beslut. Fråga: "Vad behöver ni för att gå vidare?"'
                });
            }
            
            // Behovskartläggning utan värde
            if (deal.stage === 'Behovskartläggning' && !deal.value) {
                insights.push({
                    type: 'action',
                    title: 'Uppskatta deal-värde',
                    text: 'Viktigt för att prioritera och allokera resurser rätt.'
                });
            }
            
            // Kvartalsfas för befintliga kunder
            if ((deal.stage === 'Pågående uppdrag' || deal.existingCustomer) && deal.created) {
                const monthsSince = Math.floor(daysSince(deal.created) / 30);
                if (monthsSince > 0 && monthsSince % 3 === 0) {
                    insights.push({
                        type: 'opportunity',
                        title: 'Q-fas - Merförsäljning',
                        text: `${monthsSince / 3} kvartal sedan start. Tid att diskutera expansion.`
                    });
                }
            }
            
            // Prospekt → Första kontakt tips
            if (deal.stage === 'Första kontakt' && days < 3) {
                insights.push({
                    type: 'tip',
                    title: 'Nytt prospekt',
                    text: 'Fokus: Förstå behov, inte sälja. Ställ öppna frågor.'
                });
            }
            
            return insights;
        }
            }
            
            return insights.length > 0 ? insights.join('') : null;
        }

        // Filters
        let activeFilters = {
            missingContact: false,
            missingNext: false,
            missingValue: false,
            missingProblem: false,
            incomplete: false,
            complete: false,
            owner: ''
        };

        // Apply filters
        function applyFilters() {
            activeFilters = {
                missingContact: document.getElementById('filter-missing-contact').checked,
                missingNext: document.getElementById('filter-missing-next').checked,
                missingValue: document.getElementById('filter-missing-value').checked,
                missingKam: document.getElementById('filter-missing-kam').checked,
                incomplete: document.getElementById('filter-incomplete').checked,
                complete: document.getElementById('filter-complete').checked,
                owner: document.getElementById('filter-owner').value,
                stage: document.getElementById('filter-stage').value
            };
            
            updatePipelineView();
        }

        // Clear filters
        function clearFilters() {
            document.getElementById('filter-missing-contact').checked = false;
            document.getElementById('filter-missing-next').checked = false;
            document.getElementById('filter-missing-value').checked = false;
            document.getElementById('filter-missing-kam').checked = false;
            document.getElementById('filter-incomplete').checked = false;
            document.getElementById('filter-complete').checked = false;
            document.getElementById('filter-owner').value = '';
            document.getElementById('filter-stage').value = '';
            
            applyFilters();
        }

        // Filter deals based on active filters
        function filterDeals(deals) {
            return deals.filter(deal => {
                // Owner filter
                if (activeFilters.owner && deal.owner !== activeFilters.owner) {
                    return false;
                }
                
                // Stage filter
                if (activeFilters.stage && deal.stage !== activeFilters.stage) {
                    return false;
                }
                
                // Data quality filters
                const quality = calculateDataQuality(deal);
                
                if (activeFilters.missingContact && deal.contact) return false;
                if (activeFilters.missingNext && deal.nextStep) return false;
                if (activeFilters.missingValue && deal.value > 0) return false;
                if (activeFilters.missingKam && deal.kam) return false;
                if (activeFilters.incomplete && quality.percentage >= 50) return false;
                if (activeFilters.complete && quality.percentage < 80) return false;
                
                return true;
            });
        }

        // Update Pipeline View (HUVUDVY)
        function updatePipelineView() {
            const activeDeals = deals.filter(d => d.stage !== 'Förlorad' && d.stage !== 'Vunnen');
            const allDeals = deals;
            
            // Populate owner filter dropdown
            const ownerSelect = document.getElementById('filter-owner');
            const currentOwner = ownerSelect.value;
            const owners = [...new Set(deals.map(d => d.owner))].sort();
            ownerSelect.innerHTML = '<option value="">Alla</option>';
            owners.forEach(owner => {
                const opt = document.createElement('option');
                opt.value = owner;
                opt.textContent = owner;
                if (owner === currentOwner) opt.selected = true;
                ownerSelect.appendChild(opt);
            });
            
            // Calculate overall data quality
            const avgQuality = activeDeals.length > 0
                ? Math.round(activeDeals.reduce((sum, d) => sum + calculateDataQuality(d).percentage, 0) / activeDeals.length)
                : 0;
            
            // Stats
            const totalValue = activeDeals.reduce((sum, d) => sum + d.value, 0);
            const avgValue = activeDeals.length > 0 ? totalValue / activeDeals.length : 0;
            
            document.getElementById('pipeline-total-value').textContent = formatCurrency(totalValue);
            document.getElementById('pipeline-deal-count').textContent = activeDeals.length;
            document.getElementById('pipeline-avg-value').textContent = formatCurrency(avgValue);
            document.getElementById('pipeline-data-quality').textContent = avgQuality + '%';
            
            // Apply filters and render all deals
            const filteredDeals = filterDeals(allDeals);
            const allDealsHtml = filteredDeals.length > 0
                ? filteredDeals.map(renderDealCard).join('')
                : allDeals.length > 0 
                    ? '<div class="empty-state"><h3>Inga deals matchar filtret</h3><p>Justera eller rensa filter för att se deals.</p></div>'
                    : '<div class="empty-state"><h3>Inga deals än</h3><p>Lägg till din första deal!</p></div>';
            
            document.getElementById('all-deals').innerHTML = allDealsHtml;
        }

        // Update Team View
        function updateTeamView() {
            const activeDeals = deals.filter(d => d.stage !== 'Förlorad' && d.stage !== 'Vunnen');
            const hotDeals = activeDeals.filter(d => d.stage === 'Offert' || d.stage === 'Förhandling' || d.stage === 'Pågående uppdrag');
            const staleDeals = activeDeals.filter(d => daysSince(d.lastActivity) > 21);
            
            const totalValue = activeDeals.reduce((sum, d) => sum + d.value, 0);
            
            document.getElementById('team-total-value').textContent = formatCurrency(totalValue);
            document.getElementById('team-deal-count').textContent = activeDeals.length;
            document.getElementById('team-hot-count').textContent = hotDeals.length;
            document.getElementById('team-risk-count').textContent = staleDeals.length;
            
            // Hot deals
            const hotDealsHtml = hotDeals.length > 0 
                ? hotDeals.map(renderDealCard).join('')
                : '<div class="empty-state"><h3>Inga skarpa lägen just nu</h3></div>';
            document.getElementById('hot-deals').innerHTML = hotDealsHtml;
            
            // Stale deals
            const staleDealsHtml = staleDeals.length > 0
                ? staleDeals.map(renderDealCard).join('')
                : '<div class="empty-state"><h3>Inget står stilla!</h3></div>';
            document.getElementById('stale-deals').innerHTML = staleDealsHtml;
            
            // Network opportunities (placeholder)
            document.getElementById('network-opportunities').innerHTML = `
                <div class="insight-box">
                    <h4>Network Intelligence</h4>
                    <p><em>Ladda upp LinkedIn-kontakter för att se network opportunities</em></p>
                    <p style="margin-top: 10px;">När du laddar upp konsulters LinkedIn CSV kommer systemet automatiskt matcha mot aktiva deals och visa:</p>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>Vilka konsulter som har kontakter på prospektkunder</li>
                        <li>Warm intro-möjligheter</li>
                        <li>Bästa timing för introduktioner</li>
                    </ul>
                </div>
            `;
        }

        // Update Kunder View
        function updateKunderView() {
            // Gruppera alla deals per företag för att se historik
            const customerMap = {};
            
            deals.forEach(deal => {
                if (!customerMap[deal.company]) {
                    customerMap[deal.company] = {
                        name: deal.company,
                        deals: [],
                        totalRevenue: 0,
                        owners: new Set(),
                        existingCustomer: deal.existingCustomer || false
                    };
                }
                customerMap[deal.company].deals.push(deal);
                customerMap[deal.company].totalRevenue += deal.value;
                if (deal.owner) customerMap[deal.company].owners.add(deal.owner);
            });
            
            const customers = Object.values(customerMap);
            
            // Filter - visa bara befintliga kunder ELLER kunder med flera deals
            const existingCustomers = customers.filter(c => 
                c.existingCustomer || c.deals.length > 1 || 
                c.deals.some(d => d.stage === 'Vunnen' || d.existingCustomer)
            );
            
            // Stats
            document.getElementById('kunder-total').textContent = existingCustomers.length;
            document.getElementById('kunder-revenue').textContent = formatCurrency(
                existingCustomers.reduce((sum, c) => sum + c.totalRevenue, 0)
            );
            document.getElementById('kunder-avg').textContent = existingCustomers.length > 0
                ? formatCurrency(existingCustomers.reduce((sum, c) => sum + c.totalRevenue, 0) / existingCustomers.length)
                : '0 kr';
            
            // Lista kunder
            const customerListHtml = existingCustomers.length > 0
                ? existingCustomers
                    .sort((a, b) => b.totalRevenue - a.totalRevenue)
                    .map(customer => `
                        <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 2px solid #e5e7eb;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                <div>
                                    <h3 style="margin: 0 0 5px 0;">${customer.name}</h3>
                                    <div style="color: #6b7280; font-size: 0.9em;">
                                        Ansvarig: ${Array.from(customer.owners).join(', ') || '—'}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 1.5em; font-weight: 600; color: #2563eb;">
                                        ${formatCurrency(customer.totalRevenue)}
                                    </div>
                                    <div style="color: #6b7280; font-size: 0.9em;">
                                        ${customer.deals.length} deal${customer.deals.length > 1 ? 's' : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 15px;">
                                <strong>Historik:</strong>
                                ${customer.deals.map(d => `
                                    <div style="padding: 10px; background: #f9fafb; border-radius: 6px; margin-top: 8px;">
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>${d.service || 'Tjänst ej angiven'} - ${d.stage}</span>
                                            <span style="font-weight: 600;">${formatCurrency(d.value)}</span>
                                        </div>
                                        ${d.learnings ? `<div style="margin-top: 5px; font-size: 0.9em; color: #6b7280;">Lärdom: ${d.learnings}</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')
                : '<div class="empty-state"><p>Inga befintliga kunder ännu. Markera deals som "Befintlig kund" för att se dem här.</p></div>';
            
            document.getElementById('customer-list').innerHTML = customerListHtml;
        }

        // Update Konsult View
        function updateKonsultView() {
            const selector = document.getElementById('konsult-selector');
            const content = document.getElementById('konsult-content');
            
            // Populate konsult selector
            const owners = [...new Set(deals.map(d => d.owner))].sort();
            if (selector.options.length === 1) { // Only default option
                owners.forEach(owner => {
                    const option = document.createElement('option');
                    option.value = owner;
                    option.textContent = owner;
                    selector.appendChild(option);
                });
            }
            
            const selectedOwner = selector.value;
            if (!selectedOwner) {
                content.classList.add('hidden');
                return;
            }
            
            content.classList.remove('hidden');
            document.getElementById('konsult-name').textContent = selectedOwner;
            
            // Konsult's deals
            const myDeals = deals.filter(d => d.owner === selectedOwner && d.stage !== 'Tappat uppdrag');
            const dealsHtml = myDeals.length > 0
                ? myDeals.map(renderDealCard).join('')
                : '<div class="empty-state"><p>Inga aktiva deals</p></div>';
            document.getElementById('konsult-deals').innerHTML = dealsHtml;
            
            // Today's actions
            const actions = [];
            myDeals.forEach(deal => {
                const days = daysSince(deal.lastActivity);
                if (days > 14 && !deal.nextStep) {
                    actions.push({
                        icon: 'RISK',
                        title: `Följ upp ${deal.company}`,
                        desc: `${days} dagar sen senaste aktivitet. Boka uppföljningsmöte.`
                    });
                }
                if (deal.stage === 'Tut!' || deal.stage === 'Skarpt läge') {
                    actions.push({
                        icon: 'HOT',
                        title: `${deal.company} är hot!`,
                        desc: `Säkerställ att du har case och nästa steg klart.`
                    });
                }
            });
            
            const actionsHtml = actions.length > 0
                ? actions.map(a => `
                    <li class="action-item">
                        <span class="action-icon">${a.icon}</span>
                        <div class="action-content">
                            <div class="action-title">${a.title}</div>
                            <div class="action-desc">${a.desc}</div>
                        </div>
                    </li>
                `).join('')
                : '<li class="action-item"><span class="action-icon">[OK]</span><div class="action-content"><div class="action-title">Allt ser bra ut!</div><div class="action-desc">Inga kritiska actions idag.</div></div></li>';
            
            document.getElementById('konsult-today').innerHTML = actionsHtml;
            
            // Network (placeholder)
            document.getElementById('konsult-network').innerHTML = `
                <div class="insight-box">
                    <h4> Ditt Nätverk</h4>
                    <p><em>Ladda upp dina LinkedIn-kontakter för personliga network insights</em></p>
                </div>
            `;
        }

        // Update Ledning View
        function updateLedningView() {
            const activeDeals = deals.filter(d => d.stage !== 'Tappat uppdrag');
            
            // Avg deal value
            const avgDeal = activeDeals.length > 0
                ? activeDeals.reduce((sum, d) => sum + d.value, 0) / activeDeals.length
                : 0;
            document.getElementById('ledning-avg-deal').textContent = formatCurrency(avgDeal);
            
            // Avg cycle time
            const avgCycle = activeDeals.length > 0
                ? activeDeals.reduce((sum, d) => sum + daysSince(d.created), 0) / activeDeals.length
                : 0;
            document.getElementById('ledning-cycle-time').textContent = Math.round(avgCycle) + ' dagar';
            
            // Service breakdown
            const serviceMap = {};
            activeDeals.forEach(d => {
                const service = d.service || 'Övrigt';
                serviceMap[service] = (serviceMap[service] || 0) + d.value;
            });
            
            const serviceHtml = Object.entries(serviceMap)
                .sort((a, b) => b[1] - a[1])
                .map(([service, value]) => `
                    <div class="insight-box">
                        <strong>${service}:</strong> ${formatCurrency(value)}
                    </div>
                `).join('');
            document.getElementById('service-breakdown').innerHTML = serviceHtml || '<p>Ingen data än</p>';
            
            // Consultant breakdown
            const consultantMap = {};
            activeDeals.forEach(d => {
                consultantMap[d.owner] = (consultantMap[d.owner] || 0) + d.value;
            });
            
            const consultantHtml = Object.entries(consultantMap)
                .sort((a, b) => b[1] - a[1])
                .map(([owner, value]) => `
                    <div class="insight-box">
                        <strong>${owner}:</strong> ${formatCurrency(value)}
                    </div>
                `).join('');
            document.getElementById('consultant-breakdown').innerHTML = consultantHtml || '<p>Ingen data än</p>';
            
            // Leakage analysis
            const staleDeals = activeDeals.filter(d => daysSince(d.lastActivity) > 60);
            const noNextStep = activeDeals.filter(d => !d.nextStep);
            
            const leakageHtml = `
                <div class="insight-box warning">
                    <h4>${staleDeals.length} deals utan aktivitet >60 dagar</h4>
                    <p>Värde i risk: ${formatCurrency(staleDeals.reduce((sum, d) => sum + d.value, 0))}</p>
                </div>
                <div class="insight-box warning">
                    <h4>${noNextStep.length} deals utan planerat nästa steg</h4>
                    <p>Deals utan next step dör ofta i tysthet.</p>
                </div>
            `;
            document.getElementById('leakage-analysis').innerHTML = leakageHtml;
            
            // Recommendations
            const recommendations = [];
            
            if (staleDeals.length > 0) {
                recommendations.push(`
                    <div class="learning-item">
                        <strong>1. Fix stale deals</strong><br>
                        ${staleDeals.length} deals behöver omedelbar aktivitet. Prioritera uppföljning.
                    </div>
                `);
            }
            
            if (noNextStep.length > activeDeals.length * 0.3) {
                recommendations.push(`
                    <div class="learning-item">
                        <strong>2. Förbättra next-step discipline</strong><br>
                        ${Math.round(noNextStep.length / activeDeals.length * 100)}% av deals saknar nästa steg. 
                        Implementera regel: Alltid boka nästa möte under nuvarande möte.
                    </div>
                `);
            }
            
            document.getElementById('strategic-recommendations').innerHTML = 
                recommendations.length > 0 ? recommendations.join('') : '<p>Ser bra ut! Fortsätt som ni gör.</p>';
        }

        // Update Retro View
        function updateRetroView() {
            const wonDeals = deals.filter(d => d.stage === 'Vunnen' || (d.value > 0 && d.stage === 'Tut!'));
            const lostDeals = deals.filter(d => d.stage === 'Tappat uppdrag');
            
            // Wins
            const winsHtml = wonDeals.length > 0
                ? wonDeals.map(deal => `
                    <div class="learning-item">
                        <strong>${deal.company}</strong> - ${formatCurrency(deal.value)}<br>
                        Service: ${deal.service || '—'}<br>
                        Owner: ${deal.owner}<br>
                        Cycle: ${daysSince(deal.created)} dagar
                    </div>
                `).join('')
                : '<p>Ingen vunnen deal registrerad än</p>';
            document.getElementById('retro-wins').innerHTML = winsHtml;
            
            // Losses
            const lossesHtml = lostDeals.length > 0
                ? lostDeals.map(deal => `
                    <div class="learning-item" style="border-left-color: #ef4444;">
                        <strong>${deal.company}</strong> - ${formatCurrency(deal.value)}<br>
                        Service: ${deal.service || '—'}<br>
                        Anledning: ${deal.comment || 'Inte specificerat'}
                    </div>
                `).join('')
                : '<p>Ingen förlorad deal registrerad än</p>';
            document.getElementById('retro-losses').innerHTML = lossesHtml;
            
            // Learnings
            const learnings = [];
            
            if (wonDeals.length > 0) {
                const avgWonValue = wonDeals.reduce((sum, d) => sum + d.value, 0) / wonDeals.length;
                learnings.push(`<div class="learning-item">
                    <strong>Genomsnittligt vunnet deal:</strong> ${formatCurrency(avgWonValue)}
                </div>`);
            }
            
            if (lostDeals.length > 0) {
                learnings.push(`<div class="learning-item">
                    <strong>Förlorade deals:</strong> ${lostDeals.length} st. Analysera varför för att förbättra win-rate.
                </div>`);
            }
            
            const staleDeals = deals.filter(d => d.stage !== 'Tappat uppdrag' && daysSince(d.lastActivity) > 60);
            if (staleDeals.length > 0) {
                learnings.push(`<div class="learning-item" style="border-left-color: #f59e0b;">
                    <strong>Pattern:</strong> Deals utan aktivitet >60 dagar har hög risk att dö. 
                    ${staleDeals.length} deals i denna kategori just nu.
                </div>`);
            }
            
            document.getElementById('retro-learnings').innerHTML = 
                learnings.length > 0 ? learnings.join('') : '<p>Samla mer data för insights</p>';
            
            // Focus
            const focus = [];
            if (staleDeals.length > 0) {
                focus.push(`<li>Aktivera ${staleDeals.length} stale deals</li>`);
            }
            focus.push(`<li>Dokumentera vad som funkar i vunna deals</li>`);
            focus.push(`<li>Analysera förluster för att förbättra approach</li>`);
            
            document.getElementById('retro-focus').innerHTML = '<ul style="margin-left: 20px;">' + focus.join('') + '</ul>';
        }

        // Update all views
        function updateAllViews() {
            updatePipelineView();
            updateTeamView();
            updateKunderView();
            updateKonsultView();
            updateLedningView();
            updateRetroView();
        }

        // Delete deal
        function deleteDeal(id) {
            if (confirm('Är du säker på att du vill radera denna deal?')) {
                deals = deals.filter(d => d.id !== id);
                saveData();
                updateAllViews();
            }
        }

        // Edit deal (placeholder)
        function editDeal(id) {
            alert('Edit-funktionalitet kommer snart! För nu: radera och skapa ny.');
        }

        // Export data
        function exportData() {
            const dataStr = JSON.stringify(deals, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'doings-deals-' + new Date().toISOString().split('T')[0] + '.json';
            link.click();
        }

        // CSV Import/Export
        let pendingCSVDeals = [];

        // Download CSV template
        function downloadCSVTemplate() {
            // Exakt samma struktur som er Slack säljpipe CSV
            const template = `Kund;Kommentarer;Intäkt;2;Stage;Uppdrag (rubrik);Kontaktperson;Deal owner;Kommentar/status;Fakturerat per 2026
Exempel AB;Kommentar här;500000;2;Kundsnack;Ledarutveckling;Anna Andersson;emma.forsgren@gmail.com;Första mötet bokat;
Företag XYZ;Hett läge;1000000;3;Tut!;OneBrand;Per Persson;johanna3friman@gmail.com;Offert skickad;`;
            
            const blob = new Blob([template], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'saljpipe_mall.csv';
            link.click();
        }

        // Import CSV
        function importCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const parsed = parseCSV(csv);
                    
                    if (parsed.length === 0) {
                        alert('Kunde inte hitta några deals i CSV-filen');
                        return;
                    }
                    
                    pendingCSVDeals = parsed;
                    showCSVPreview(parsed);
                    
                } catch (err) {
                    alert('Fel vid CSV-import: ' + err.message);
                    console.error(err);
                }
            };
            reader.readAsText(file, 'UTF-8');
        }

        // Parse CSV and map to our data structure
        function parseCSV(csv) {
            try {
                // Clean the CSV - remove BOM and normalize line endings
                csv = csv.replace(/^\uFEFF/, ''); // Remove BOM
                csv = csv.replace(/\r\n/g, '\n').replace(/\r/g, '\n'); // Normalize line endings
                
                const allLines = csv.split('\n').map(line => line.trim()).filter(line => line.length > 0);
                
                if (allLines.length < 2) {
                    console.error('CSV file is empty or has only one line');
                    alert('CSV-filen verkar vara tom eller saknar data. Kontrollera att filen innehåller både header och minst en rad med data.');
                    return [];
                }
                
                console.log('Total lines in CSV:', allLines.length);
                console.log('First 3 lines:', allLines.slice(0, 3));
                
                // Detect delimiter - check multiple lines, not just first
                let delimiter = ',';
                for (let i = 0; i < Math.min(3, allLines.length); i++) {
                    if (allLines[i].includes(';')) {
                        delimiter = ';';
                        break;
                    }
                }
                console.log('Detected delimiter:', delimiter);
                
                // Find header row - look for row with "Kund", "Stage", or "Company"
                let headerIndex = -1;
                for (let i = 0; i < Math.min(5, allLines.length); i++) {
                    const line = allLines[i].toLowerCase();
                    if (line.includes('kund') || line.includes('stage') || line.includes('company') || line.includes('intäkt')) {
                        headerIndex = i;
                        console.log('Found header at line:', i + 1);
                        break;
                    }
                }
                
                if (headerIndex === -1) {
                    console.error('Could not find header row');
                    console.log('Searched first 5 lines:', allLines.slice(0, 5));
                    alert('Kunde inte hitta header-rad med "Kund", "Stage" eller "Intäkt".\n\nKontrollera att CSV-filen har dessa kolumner.');
                    return [];
                }
                
                const lines = allLines.slice(headerIndex);
                const header = lines[0].split(delimiter).map(h => h.trim().replace(/^"|"$/g, ''));
                
                console.log('Header columns:', header);
                
                // Map column names to our fields
                const columnMap = {};
                header.forEach((col, index) => {
                    const normalized = col.toLowerCase().trim();
                    
                    if (normalized.includes('kund') || normalized === 'company' || normalized === 'företag') {
                        columnMap[index] = 'company';
                        console.log('Column', index, '('+col+') mapped to: company');
                    }
                    else if (normalized === 'intäkt' || normalized.includes('intäkt') || 
                             normalized === 'value' || normalized === 'värde' || 
                             normalized === 'deal-värde' || /^\d{5,}$/.test(normalized)) {
                        columnMap[index] = 'value';
                        console.log('Column', index, '('+col+') mapped to: value');
                    }
                    else if (/^[123]$/.test(normalized) || normalized === '2') {
                        columnMap[index] = 'confidence';
                        console.log('Column', index, '('+col+') mapped to: confidence');
                    }
                    else if (normalized === 'stage' || normalized.includes('steg')) {
                        columnMap[index] = 'stage';
                        console.log('Column', index, '('+col+') mapped to: stage');
                    }
                // Service
                else if (normalized.includes('uppdrag') || normalized === 'service' || normalized === 'typ av uppdrag') {
                    columnMap[index] = 'service';
                }
                // Contact
                else if (normalized.includes('kontaktperson') || normalized === 'kontakt' || normalized === 'contact') {
                    columnMap[index] = 'contact';
                }
                // Owner
                else if (normalized.includes('deal owner') || normalized === 'owner' || normalized === 'ägare') {
                    columnMap[index] = 'owner';
                }
                // Comment/Status
                else if (normalized.includes('kommentar') || normalized.includes('status')) {
                    columnMap[index] = 'comment';
                }
            });
            
            console.log('Column mapping:', columnMap);
            
            const deals = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                if (!line.trim()) continue;
                
                // Parse CSV line (handle quoted fields)
                const values = [];
                let current = '';
                let inQuotes = false;
                
                for (let char of line) {
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === delimiter && !inQuotes) {
                        values.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim());
                
                const deal = {
                    id: Date.now() + i + Math.random() * 1000,
                    company: '',
                    value: 0,
                    stage: 'Kundsnack',
                    owner: '',
                    service: '',
                    contact: '',
                    confidence: null,
                    problem: '',
                    nextStep: '',
                    comment: '',
                    other: '',
                    existingCustomer: false, // Befintlig kund eller ny?
                    learnings: '', // Vad lärde vi oss?
                    lastActivity: new Date().toISOString().split('T')[0],
                    created: new Date().toISOString()
                };
                
                // Map values using column mapping
                for (let j = 0; j < values.length; j++) {
                    const value = values[j].replace(/^"|"$/g, '').trim();
                    if (!value) continue;
                    
                    const mappedField = columnMap[j];
                    
                    if (mappedField === 'company') {
                        deal.company = value;
                    } else if (mappedField === 'value') {
                        // ENDAST läs ren siffra från Intäkt-kolumnen
                        // Exempel: "2000000" → 2000000
                        //          "180000" → 180000
                        //          "" → 0
                        const numStr = value.replace(/[^0-9]/g, '');
                        if (numStr) {
                            deal.value = parseInt(numStr);
                        }
                    } else if (mappedField === 'stage') {
                        deal.stage = value;
                    } else if (mappedField === 'confidence') {
                        // Parse confidence level (1, 2, 3)
                        const conf = parseInt(value);
                        if (conf >= 1 && conf <= 3) {
                            deal.confidence = conf;
                        }
                    } else if (mappedField === 'owner') {
                        // Extract email or name
                        const emailMatch = value.match(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/);
                        if (emailMatch) {
                            const email = emailMatch[1];
                            // Extract name from email (part before @)
                            const namePart = email.split('@')[0];
                            // Handle formats like "emma.forsgren" → "Emma"
                            const firstName = namePart.split('.')[0];
                            deal.owner = firstName.charAt(0).toUpperCase() + firstName.slice(1);
                        } else {
                            deal.owner = value;
                        }
                    } else if (mappedField === 'service') {
                        deal.service = value;
                    } else if (mappedField === 'contact') {
                        deal.contact = value;
                    } else if (mappedField === 'comment') {
                        deal.comment = value;
                    } else if (!mappedField && header[j] && value) {
                        // Unknown column -> add to "other"
                        if (deal.other) deal.other += '\n';
                        deal.other += `${header[j]}: ${value}`;
                    }
                }
                
                // Only add if we have at least company
                if (deal.company) {
                    deals.push(deal);
                    console.log('Added deal:', deal.company, '=', deal.value, 'kr');
                } else {
                    console.log('Skipped row (no company):', line.substring(0, 50));
                }
            }
            
            console.log('Parsed deals:', deals.length);
            if (deals.length > 0) {
                console.log('First deal:', deals[0]);
                console.log('Total value:', deals.reduce((sum, d) => sum + d.value, 0), 'kr');
            } else {
                alert('Kunde inte hitta några deals i CSV-filen.\n\nDebug info i console (tryck F12)');
            }
            return deals;
            
            } catch (error) {
                console.error('Error parsing CSV:', error);
                alert('Fel vid läsning av CSV: ' + error.message);
                return [];
            }
        }

        // Show CSV preview
        function showCSVPreview(deals) {
            const preview = document.getElementById('csv-preview');
            const content = document.getElementById('csv-preview-content');
            
            let html = `
                <div style="margin-bottom: 15px; font-weight: 600;">
                    Hittade ${deals.length} deals i CSV-filen
                </div>
                <div style="max-height: 400px; overflow-y: auto;">
            `;
            
            deals.slice(0, 5).forEach(deal => {
                html += `
                    <div style="padding: 15px; background: white; border-radius: 8px; margin-bottom: 10px; border: 2px solid #e5e7eb;">
                        <strong>${deal.company}</strong> - ${formatCurrency(deal.value)}<br>
                        Stage: ${deal.stage} | Owner: ${deal.owner}<br>
                        ${deal.service ? `Service: ${deal.service}<br>` : ''}
                        ${deal.comment ? `Kommentar: ${deal.comment.substring(0, 100)}...<br>` : ''}
                    </div>
                `;
            });
            
            if (deals.length > 5) {
                html += `<div style="text-align: center; color: #6b7280; margin-top: 10px;">
                    ... och ${deals.length - 5} deals till
                </div>`;
            }
            
            html += '</div>';
            
            content.innerHTML = html;
            preview.classList.remove('hidden');
        }

        // Confirm CSV import
        function confirmCSVImport() {
            if (!pendingCSVDeals || pendingCSVDeals.length === 0) return;
            
            const importMode = confirm(
                `Importera ${pendingCSVDeals.length} deals.\n\n` +
                `Klicka OK för att LÄGGA TILL deals (behåller befintliga)\n` +
                `Klicka Avbryt för att gå tillbaka`
            );
            
            if (importMode) {
                // Add to existing deals
                deals = [...deals, ...pendingCSVDeals];
            } else {
                return;
            }
            
            saveData();
            
            document.getElementById('csv-preview').classList.add('hidden');
            pendingCSVDeals = [];
            
            alert(`${pendingCSVDeals.length} deals importerade!`);
            updateAllViews();
            
            // Switch to pipeline view
            document.querySelector('.tab').click();
        }

        // Cancel CSV import
        function cancelCSVImport() {
            document.getElementById('csv-preview').classList.add('hidden');
            pendingCSVDeals = [];
        }

        // Export as CSV
        function exportCSV() {
            if (deals.length === 0) {
                alert('Inga deals att exportera');
                return;
            }
            
            // CSV header
            let csv = 'Företag,Värde,Stage,Owner,Service,Kontakt,Senaste Aktivitet,Nästa Steg,Problem,Kommentar,Övrigt\n';
            
            // Add rows
            deals.forEach(deal => {
                const row = [
                    escapeCSV(deal.company),
                    deal.value,
                    escapeCSV(deal.stage),
                    escapeCSV(deal.owner),
                    escapeCSV(deal.service),
                    escapeCSV(deal.contact),
                    deal.lastActivity,
                    escapeCSV(deal.nextStep),
                    escapeCSV(deal.problem),
                    escapeCSV(deal.comment),
                    escapeCSV(deal.other)
                ];
                csv += row.join(',') + '\n';
            });
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'doings-pipeline-' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
        }

        // Escape CSV field
        function escapeCSV(field) {
            if (!field) return '';
            const str = String(field);
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                return '"' + str.replace(/"/g, '""') + '"';
            }
            return str;
        }

        // Delete all data
        function deleteAllData() {
            const confirmed = confirm(
                'VARNING: Detta raderar ALL data från systemet.\n\n' +
                'Alla deals, kommentarer och inställningar försvinner permanent.\n\n' +
                'Vill du fortsätta?'
            );
            
            if (!confirmed) return;
            
            const doubleCheck = confirm(
                'Är du HELT säker?\n\n' +
                'Detta kan INTE ångras!\n\n' +
                'Klicka OK för att radera all data.'
            );
            
            if (!doubleCheck) return;
            
            // Clear all data
            deals = [];
            saveData();
            
            // Clear filters
            clearFilters();
            
            // Update all views
            updateAllViews();
            
            alert('All data raderad!');
        }

        // Import data
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (confirm(`Importera ${imported.length} deals? Detta kommer ersätta nuvarande data.`)) {
                        deals = imported;
                        saveData();
                        updateAllViews();
                        alert('Data importerad!');
                    }
                } catch (err) {
                    alert('Fel vid import: ' + err.message);
                }
            };
            reader.readAsText(file);
        }

        // Load sample data
        function loadSampleData() {
            if (!confirm('Ladda exempeldata? Detta kommer lägga till flera exempel-deals.')) return;
            
            const sampleDeals = [
                {
                    id: Date.now() + 1,
                    company: 'Mojang AB',
                    value: 2500000,
                    stage: 'Tut!',
                    owner: 'Emma',
                    service: 'Ledarutveckling + OneBrand',
                    contact: 'Maria Svensson (Head of HR)',
                    lastActivity: '2026-01-15',
                    nextStep: 'Pitch på torsdag 23 jan',
                    comment: 'Vi ska pitcha tillsammans med två andra leverantörer men de vill jobba med oss',
                    problem: 'Växer snabbt, behöver stärka kultur och ledarskap',
                    created: '2025-12-01'
                },
                {
                    id: Date.now() + 2,
                    company: 'H&M Brand',
                    value: 450000,
                    stage: 'Kundsnack',
                    owner: 'Jennifer',
                    service: 'Ledarutveckling',
                    contact: 'Per Lindroth',
                    lastActivity: '2025-11-13',
                    nextStep: '',
                    comment: 'Ny konstellation i LG, kanske aktuellt Q1 2026',
                    problem: 'Ny ledargrupp behöver utvecklas',
                    created: '2025-11-01'
                },
                {
                    id: Date.now() + 3,
                    company: 'Volvo Cars',
                    value: 380000,
                    stage: 'Skarpt läge',
                    owner: 'Marcus',
                    service: 'OneBrand + Kultur',
                    contact: 'Anna Berg (L&D)',
                    lastActivity: '2026-01-10',
                    nextStep: 'Discovery-möte 25 jan',
                    comment: 'Warm intro via Marcus nätverk fungerade!',
                    problem: 'Tech-teams förlorar kultur i hybrid work',
                    created: '2026-01-05'
                },
                {
                    id: Date.now() + 4,
                    company: 'Aleris',
                    value: 180000,
                    stage: 'Skriver/skickat offert',
                    owner: 'Eva',
                    service: 'Ledarskapscoaching',
                    contact: 'HR-chef',
                    lastActivity: '2026-01-08',
                    nextStep: 'Uppföljning offert',
                    comment: 'Offert skickad, väntar på svar',
                    problem: 'Nya chefer behöver stöd',
                    created: '2025-12-15'
                },
                {
                    id: Date.now() + 5,
                    company: 'Espresso House',
                    value: 180000,
                    stage: 'Tappat uppdrag',
                    owner: 'Anna',
                    service: 'HR Tech',
                    contact: 'Lisa',
                    lastActivity: '2025-11-20',
                    nextStep: '',
                    comment: 'De ville ha tech-leverantör, vi passade inte',
                    problem: 'Ville mappa processer i HR-system',
                    created: '2025-10-15'
                }
            ];
            
            deals = [...deals, ...sampleDeals];
            saveData();
            updateAllViews();
            alert('Exempeldata laddad!');
        }
    </script>
</body>
</html>
